import{_ as i,W as l,X as p,Y as n,Z as s,$ as e,a0 as t,C as c}from"./framework-16b96b76.js";const o="/cs-tips/assets/1699281007111-ad429dbd.png",u="/cs-tips/assets/1699933266972-f23c815c.png",d="/cs-tips/assets/1699933267180-89c8aa83.png",r="/cs-tips/assets/1699933267257-1be7cea2.png",k="/cs-tips/assets/1699933267360-65b86c46.png",v="/cs-tips/assets/1699933267437-66ad47bc.png",m="/cs-tips/assets/1699933267517-df6a97e9.png",b="/cs-tips/assets/1699933267595-4ade3ec6.png",g="/cs-tips/assets/1699933267677-877884c6.png",h="/cs-tips/assets/1699933267759-97a510e6.png",f="/cs-tips/assets/1699933267833-25b07985.png",y="/cs-tips/assets/1699933267924-0ad63a2f.png",_="/cs-tips/assets/1699933268008-9f82953b.png",x="/cs-tips/assets/1699933268105-9747f0e7.png",w="/cs-tips/assets/1699933268185-bcb14b3e.png",S="/cs-tips/assets/1699933268274-099cf22c.png",E="/cs-tips/assets/1699933268353-ac1bc390.png",C="/cs-tips/assets/1699933269664-842fcd87.png",T="/cs-tips/assets/1699933269756-7cfd0d41.png",N="/cs-tips/assets/1699933269970-cba94f7a.png",A="/cs-tips/assets/1699933270080-ec37175d.png",q="/cs-tips/assets/1699933270197-f691cc7f.png",R="/cs-tips/assets/1699933270289-2cb81419.png",L="/cs-tips/assets/1699933270387-0ee1b7f4.png",I="/cs-tips/assets/1699933270479-651678d5.png",O="/cs-tips/assets/1699933270573-9a4a769c.png",M="/cs-tips/assets/1699933270655-a17d2f5d.png",U="/cs-tips/assets/1699933270749-326efcd4.png",D="/cs-tips/assets/1699933270843-67ce39ca.png",z="/cs-tips/assets/1699933270951-88aacf1b.png",j="/cs-tips/assets/1699933271036-c9c2ce74.png",B="/cs-tips/assets/1699933272698-9d6bd261.png",F="/cs-tips/assets/1699933272781-0a6db5f5.png",P="/cs-tips/assets/1699933272877-076d263c.png",G="/cs-tips/assets/1699933272953-1e77acf8.png",H="/cs-tips/assets/1699933273056-4210e92e.png",Y="/cs-tips/assets/1699933274421-0a27a6f7.png",K="/cs-tips/assets/1699933274532-3b14f3e4.png",V="/cs-tips/assets/1699933274639-8b343a55.png",J="/cs-tips/assets/1699933274724-fa7c346c.png",Z="/cs-tips/assets/1699933274803-f5d511c3.png",W="/cs-tips/assets/1705307072908-6cab5e0f.png",X="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIsAAAB7CAYAAABEi3PmAAAPJUlEQVR42u2d+VdURxbH8zdMzvw058xPExEkRo2auI1GcYkakzHHjIpnzDEqisCwKBiiRkcIbojLnEmMK4ptRDQug8YlsgQRkWYHRQUURXBDBUwCWe7Ut5p60928htedlsZw7zn3vPeq3uv3oD5ddet1VX1fIjY2g/ZSbW0tsbMb8Zf4+8JmuGbhfwEbw8LWvWH59ddfNWdjWHTt559/pvNXaym5qJ6SC+9SSnEdnSypodbW1m7xR3755ZeUkJDApd0dYHn06BH57SqkEbvLaOiOYhqRWEpjhC9PLaHb9xroxx9/bOctLS0SMkc1VENDg24ersX9HNVeuM4+Lzo6moKCgnQhf/z4MVPQlbDcvn2b/rw5n/64Po/+8FkuvbzOTC+L7Z8S8snr30XU5z/F5LutRGzF/rYi8hHbV78ooil7C+j777+3+aykpCR6/fXXqVevXvTGG2/QyZMntbz4+Hjy8fGReX5+flRVVaXlpaSk0ODBg2XegAEDaPv27TI9MDBQpsG9vLzo2rVr9Msvv9CqVavI19dXpo8YMYKys7OZhq6Apaamhnp/UUZj9lfSmL2VNG5/NY1NqqJxJuFJ4lik+Ym08Tg2Vcu00fsqyXtbGdXV1Wmf8/DhQ+rduzcdPXpU1iAo8HfffVcWLmDo168fpaWl0Z07dygkJEQCg1qksbGRxo0bR4mJiXT//n3asWOHhAD7z549o4iICJo/fz49efJEflZOTo48/8KFC/L9QVhYGE2YMIFp6CpYwnMaKaa0heJKW2lNucXXCsfxerGNLft/+mfC/1XSQqE5T+W1yh48eCC//atXr6abN2/a3CMgIICWLFlCt27dkp6bmyuBsK5d0LSh8EtLS2UeoOioGWpubpafBShxPgfmBmHBtwyFpRePZGRkdArLoktNtDS/hZYVtlJUcStFi+2yIrEvtp8UWdKWiu3HbR5Z2EJBF5tsYIGlpqbSlClTZOGNGTOGDh8+LNNRE/Tv3182GcpxnJWVJWuhyMhI2awMHDhQXofrL168qAsLms0ZM2aQt7c3DRkyhAYNGsSwOAPL1q1baf369TbAPH36VKbBf/rppw5hCRQFv8TcQovzBQgChiUFFmCwXVxgAQX7gAfHkQKsRTntYVGGJiQmJkZrTubNm0exsbG65546dYr69OlDN27ckMdobuxhQeyibOXKlTRp0iTZfMHOnDnDsDgDS1NTkw0w9sed1SyAJULAEpZvAWNxoQWaiHyLf4waJ9+SjmOAFZhrC4vZbKaRI0fKmgxwHjhwQEKAwjeZTDJmOX/+vOzxID4ZOnSofDYEwaglLl++LI8BhzUsaNZGjRpFlZWVMmb59NNPZU2F2AfN2NSpUxkWZ2MWdCNVTWIUFAXLwmxRs4jaIgK1SFvtgX3UNIvbapSlYj8c+TJdwHLJFhYUJAoWzQlilzfffJOOHDmi5a9Zs0brDaH5OHHihEz/4YcfaMGCBfIaBMhxcXFyX8FSWFhIo0ePltdVVFTIeGjixInyGE0Z4GFYXAhwAYcCxggoCpYg0aQsLWqhqLbmJ7LQAk1U235UkeU4EvmIWQoELA6aIbz/cOU9C3o+9l1x63c3uNb+y9FR88pmoDeEJgjxijO9odBLzbSsuEUGsytEMPuJ8BUlrbS82ALH8rY0mV8CiFooJKfZYczC9jvuOs8+X08LMxtoUVYDhWQ/FtvHFISt3LekLcx6QoEXkN5A8zIf0eyz9QxLT4Rl6rFK+uDUHfL/ppZmnqm1bM/eJX+xP/PUXZp52uL+p0Xe6Ts0XZz7t5TrDEtPgwUxxKaj6RR28DsKNWXSP00ZFHpAbL/KpDBsTRYPlZ4h0jIoQpybcCRNvrVl60GwICBFoaOXga6oEce5uMbRj4lsv1NY2BgWNjaGhY1hYWNY2LoNLM3PnhE7uxFnWNgZFnaGRdfPnj1LNyordfNyL1+mvLw8m7TrN27Q9h07KGHTJjr1zTf04OFDLe/+gwf039TUdo5hnPLa69flNU3NzTafebeuTp73tLFRSysuLqY9e/bQlq1b6dy339pcg+fSuw/uz7DoOP6x+HUbg5swXADDEvDTAd7swm/fuUNPRH5nn4NxL/uSknTzgoKDKTQ0VDvebzLJMS+j3nqLZsycSf3695cDocqvXJH5pWVl9JdXXqFhw4fLAVPKly1fLvN3i8JH/s5du2zucyE7W6bX37snj3eJfC9xH4zImz5jhhzENWfOHA0mPFffvn1t7gFXz8Gw2Dm+RY0dAIOBSkjvDBijsJSVl5O3jw+FhYdTY1OTTAOQ7733HvnPmmUDy1Vxb73PU7D4vvqqPFcPlofi+XGfDRs2aPn5BQUS0tSTJ3Uh5maoE8c/FmNnHAFTVFQkR+zLvA6AMQrL2rVr5dwiFKb1ORiOGRkVJZsjI7BgsDgGfGOainoua1ju3b9Pvby8yHTggM21FdeuyeaKYXERFkzH0AMGsCDWwA+NAKajGsYoLB/NnUv/mD27w2dSsGDKa8rhw5qr5gGw/HXkSBkj9R8wgNauW6fbDC0MDCQf0fRELF5Mh48ckTWY/XNN++ADm3scP3GCYekIFgyF1AMGtQumbCBILBMFiMDSUQxjFBbEKOEREYZgGePnR29PnKh58qFDNrBgH2mIS7IvXmwHy2PxN+zYuZPef/996u3tLR3gIF09F8b/Wt9j2rRpDEtHsGDMrCNg9IJeVPGuwhK4aBFNFYVnBJaOmiEFi/r8t0aPlr0da1isHc1b4t69Epht27ZxM+QqLBiZ7wwweoVhFJad4pvex9dXBrrW53x7/jzNnTdPxjLOwoIYBD2nCW+/rcFSUlJCq2Ni6JF4butrAWrU0qUMi6uwYMS9M8A4gmVDfDwVFBZqfuXq1XaFglpJFSx6J+iNnT5zhoaLgBXnWdcseJdi/XnqPY49LHDMZXqlVy8NFjh6S5hui3c6OJZddlGz7N23T3sudKWt7wFvEH8rw+IAFgSvzgCjC8uQIbKgrB1TYDVYwsK0cxH/oKuszkMBYmK8ehmmYLF3NGHI35OYKCfC2T/DylWr5HmqmcQEfvSa1PWYCxW/caP2Yg7PpXefYlErMSwOYMGCP/bAABZHwOjB4oqjpigUXfPn/U2uqq6WAFq/2eXX/S7CgkleesA4qmHcBQv7CwqLM8AwLD0YFrx06wgY+yaJYenBvw0Bis6AUTUMYpbu/Kssw/Kcf3VGAIgegBHHub+HQJFhYWdY2NkZFnaGhZ1hYe8OsPDUKTaekcjGsLD1YFi6u0YRhCc+/PBDOnjwIMPiqRt3d40i2JUrV+T6uJs3b5YLLjMsHjJ3axTBMDjK0bq2yMNvTI4Mv0PZ52PlbsjZ8GLKHobFnRpFWKNu/PjxshbAiLTw8HCt4FEjYMah0hsKDg7Wai+MZsMIe6zljxmDyMeoOcCBgdU4VtdhagjD4qaCx2Booytyw9ylUYSCx1Lr0BPCooaYk4w1/Tdu3CjzMCUUIg+QisnPz6fhw4dLOBQsgAHHEJM4d+6cBCM9PV3WYsnJyVIgC4OucMywuMGs1/x3Zgl3d2gUYSQ9Ctz6voAG8YbKs14+FeIRGEOrYAEcSh0EpkSuYJCzgUYAm5ubIWfX/HeXRtHx48dlU6JnennQVQJAiIEAy2uvvWaTjympmNTOsDznmAVBq1ITwX5nsLhDo0ipltXX12tpUDNDHGOkZmFYPBjgQtYFkixYAcEILL9VowhxCZTLIF6FuARyMcOGDWsXs+CagoKCdjELw+IBWKAVdOzYMQmK0vnpDBZ3aBTBqqurtd4QejUQ28QwTNUbGjt2rNargfyddW/IHhbMKdq9e7fWdWZY3AwLQMEbTqOgKFjcqVGktKD1ei0qTwHE5kFY0PNwBhQFC2sU9dCaxZl3LAoW1ijq4QGuM7CwRhHDYribzRpFDIshY40ihoWNYWFjY1jYGBY2hoXNs7Dw5Cl2npHIzrCw92BYsNSnclc/A2vy55nNunkZmZn09+nTqa6+ngv8RYUFKzidKq6m/Xk1lHT5FpnMNXTUXKmtbe+MQ5oFy6Hr5WUKWKD3w7C8wLBAtEFv3tDHxwup4matXMrc3jEmRW+ZMAULNIRqbt/WtIQ6cpxTe/cuQ/AiwHLt+nWX5g1NTjTbyNQpWDBUctDgwXKVakwFgaycXJdfQAShKCW4gBFzK1asoH79+slzJ7/zjvzNiWHoIlgguvT555/TrZoa49dUVLg8b6iyqqodLAMHDaL0jAy5Zv+cjz6S6/Fj9WzUOMhXq2MCEMi64Lyi4mIaIsCKiY1lGLoKFlTnseIfDjcKDGBxdd5QhZ1iB2AArOq4WtQUgAIKZXqwKOk5OFQ65gcEMAxd2QwBEmeAQYG7Om9IDxZrAOBQ5YCCmB4sl9qUVKVAg2i+0JtiGLo4ZkHQGh8fL4Gxl3nTg8XVeUNGa5ZcBzULw9JNAtxDKSkUHR0tFTeMwOLKvCE9WBDcZn73ncxD4XcUszAsHoYFXdGDyckSFMzHMdIMuTpvSA8W6P0gyAUMmOujekPWsKA31A4Wcd1chqXrYAEo0AA0CoqCxdV5QxUOJOmcec/C7iFYzPn5ToGiYHF13pAjWNhfkJrFmXcsChZX5w0xLD3sDS5e5Lk6bwjXcuH1IFgQW6xPOUchpgwK3pdOQUlpFCw8aH86hQgP2pdmSdtnSQ/Zn0ahpnRad/CsvJYLr4f96oxCx2t3CE4acZyL2YisOcSDn9gZFnaGhZ1hYWdnWNhZb4iNZySyMSxsDMtvMHfoDS1YsIDKy8vl6H9/f3+5Rj8sISGBvv76ay7lFx0Wd+oNeXt7U1ZWloRl1qxZGiwQlcLiyWwvOCzu1BtSsNibNSwAqTsJXzEsTpg79YYULBCmwiraZrNZgwX6QZMnT5bzhbCa9qFDh7jUPQmLJ/WG7GEBFHl5eRosgAerf+OaTZs2kY+Pj1zkmc1DsHhSb6gzWAICAmzOhZ6QEnJg81Az5Cm9oc5giYuLszkXg7OxdDybh2MWT+gNuVKzoMlk6wYBblfrDRmJWaB1CPGqLVu2cMzSHWDxpN4QALCGxbo3FBERQZMmTZLpffv25d6Qp2HpDnpDnZkjLSK2LoaF9YYYFqdqFtYbYliem7HeEMPiVDeb9YYYFkPGekMMCxvDwsbGsLAxLGwMC5tnYeHJU+xG/X883xARYKeCDgAAAABJRU5ErkJggg==",Q="/cs-tips/assets/1699933291836-4a3515d0.png",$="/cs-tips/assets/1699933291925-e18f29fa.png",nn="/cs-tips/assets/1699933292028-5f60d620.png",sn="/cs-tips/assets/1699933292129-e2f36d68.png",an="/cs-tips/assets/1699933292251-dd4d2ae0.png",en="/cs-tips/assets/1699933293626-1d873855.png",tn="/cs-tips/assets/1699933293759-c98e0586.png",ln="/cs-tips/assets/1699933293876-e14c42a0.png",pn="/cs-tips/assets/1699933293990-380d99e9.png",cn="/cs-tips/assets/1699933294175-71272321.png",on="/cs-tips/assets/1699933294281-2aa3362f.png",un="/cs-tips/assets/1699933294381-4f0aef5f.png",dn="/cs-tips/assets/1699933294515-687989c7.png",rn="/cs-tips/assets/1699933294615-d0297829.png",kn="/cs-tips/assets/1699944644888-8c0d65ff.jpg",vn="/cs-tips/assets/1699944644987-3dae7b1f.jpg",mn="/cs-tips/assets/1699944645086-2e9e7cdc.jpg",bn="/cs-tips/assets/1699944645188-fd870b5b.jpg",gn="/cs-tips/assets/1699944645340-f1e5a0b2.jpg",hn="/cs-tips/assets/1699944645438-91410894.jpg",fn="/cs-tips/assets/1699944645532-85470a88.jpg",yn="/cs-tips/assets/1699944645672-b42050c5.jpg",_n="/cs-tips/assets/1699944645764-4b18ffe7.jpg",xn="/cs-tips/assets/1699944645859-d675d438.jpg",wn="/cs-tips/assets/1699944645958-13b23f06.jpg",Sn="/cs-tips/assets/1699944646061-872ccc73.jpg",En="/cs-tips/assets/1699944646172-581fca17.jpg",Cn="/cs-tips/assets/1699944646281-2a36f6d0.jpg",Tn="/cs-tips/assets/1699944646387-3acb2e26.jpg",Nn="/cs-tips/assets/1699944646501-4b9564fa.jpg",An="/cs-tips/assets/1699933284574-31aee14d.png",qn="/cs-tips/assets/1699933284668-16dd1828.png",Rn="/cs-tips/assets/1699933284751-826aa480.png",Ln="/cs-tips/assets/1699933284829-e2fd1942.png",In="/cs-tips/assets/1699933284968-c31aba61.png",On="/cs-tips/assets/1699933285089-69c0ce02.png",Mn="/cs-tips/assets/1699933285186-c76086bb.png",Un="/cs-tips/assets/1699933285280-ffddb9b2.png",Dn="/cs-tips/assets/1699933285373-50f23a6d.png",zn="/cs-tips/assets/1699933285482-cb4607a9.png",jn="/cs-tips/assets/1699933285602-d3d8c42a.png",Bn="/cs-tips/assets/1699933285711-a6d28d94.png",Fn="/cs-tips/assets/1699933288803-bd4754e9.png",Pn="/cs-tips/assets/1699933288898-5695c060.png",Gn="/cs-tips/assets/1699933261729-bc9e26f3.png",Hn="/cs-tips/assets/1699933261847-7d00c672.png",Yn="/cs-tips/assets/1699933261935-b7a4e24a.png",Kn="/cs-tips/assets/1699933262024-38cf939e.png",Vn="/cs-tips/assets/1699933262109-42309356.png",Jn="/cs-tips/assets/1699933262188-5cf42830.png",Zn="/cs-tips/assets/1699933262292-cd7c5af7.png",Wn="/cs-tips/assets/1699933262418-9eb7a114.png",Xn="/cs-tips/assets/1699933262506-4c887d7b.png",Qn={},$n=t('<h1 id="springcloud" tabindex="-1"><a class="header-anchor" href="#springcloud" aria-hidden="true">#</a> springcloud</h1><p>学习的思路：一种新的技术的产生或一种新的架构思路的产生，一定是过去的旧事物无法满足现有问题的解决，或者是一定是原有的旧事物有些问题需要解决。因此，在学习新技术的时候，这种思想就可以作为一种指导思想。</p><h2 id="_1-微服务" tabindex="-1"><a class="header-anchor" href="#_1-微服务" aria-hidden="true">#</a> 1. 微服务</h2><h3 id="_1-1-什么是微服务" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是微服务" aria-hidden="true">#</a> 1.1. 什么是微服务</h3><ol><li>2014 年 <strong>Martin Fowler</strong> 提出的一种新的架构形式。微服务架构是一种<strong>架构模式</strong>，提倡将单一应用程序划分成一组小的服务，服务之间相互协调，互相配合，为用户提供最终价值。每个服务运行在其独立的进程中，服务与服务之间采用轻量级的通信机制(如HTTP或Dubbo)互相协作，每个服务都围绕着具体的业务进行构建，并且能够被独立的部署到生产环境中，另外，应尽量避免统一的，集中式的服务管理机制，对具体的一个服务而言，应根据业务上下文，选择合适的语言、工具(如Maven)对其进行构建。</li><li>微服务化的核心就是将传统的一站式应用，根据业务拆分成一个一个的服务，彻底地去耦合，每一个微服务提供单个业务功能的服务，一个服务做一件事情，从技术角度看就是一种小而独立的处理过程，类似进程的概念，能够自行单独启动或销毁，拥有自己独立的数据库。</li></ol><h3 id="_1-2-微服务解决了哪些问题" tabindex="-1"><a class="header-anchor" href="#_1-2-微服务解决了哪些问题" aria-hidden="true">#</a> 1.2. 微服务解决了哪些问题？</h3><ol><li>服务很多，客户端怎么访问，如何提供对外网关?</li><li>这么多服务，服务之间如何通信? HTTP还是RPC?</li><li>这么多服务，如何治理? 服务的注册和发现。</li><li>服务挂了怎么办？熔断机制。</li></ol><h3 id="_1-3-主流的微服务框架" tabindex="-1"><a class="header-anchor" href="#_1-3-主流的微服务框架" aria-hidden="true">#</a> 1.3. 主流的微服务框架</h3><ol><li>Spring Cloud Netflix</li><li>Spring Cloud Alibaba</li><li>SpringBoot + Dubbo + ZooKeeper</li></ol><h3 id="_1-4-springcloud-有哪些核心组件" tabindex="-1"><a class="header-anchor" href="#_1-4-springcloud-有哪些核心组件" aria-hidden="true">#</a> 1.4. SpringCloud 有哪些核心组件？</h3><figure><img src="'+o+`" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>三者关系</p><p>Spring 最初最核心的两大核心功能 Spring Ioc 和 Spring Aop 成就了 Spring，Spring 在这两大核心的功能上不断的发展，才有了 Spring 事务、Spring Mvc 等一系列伟大的产品，最终成就了 Spring 帝国，到了后期 Spring 几乎可以解决企业开发中的所有问题。 Spring Boot 是在强大的 Spring 帝国生态基础上面发展而来，发明 Spring Boot 不是为了取代 Spring ,是为了让人们更容易的使用 Spring 。 Spring Cloud 是一系列框架的有序集合。它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以用 Spring Boot 的开发风格做到一键启动和部署。 Spring Cloud 是为了解决微服务架构中服务治理而提供的一系列功能的开发框架，并且 Spring Cloud 是完全基于 Spring Boot 而开发，Spring Cloud 利用 Spring Boot 特性整合了开源行业中优秀的组件，整体对外提供了一套在微服务架构中服务治理的解决方案。</p><h2 id="_2-说明" tabindex="-1"><a class="header-anchor" href="#_2-说明" aria-hidden="true">#</a> 2. 说明</h2><p>本系列教程，主要是基于SpringCloud-Alibaba相关组件的实战演练，属于HelloWord性质的工程内容。同时，在讲解各个组件的过程中会穿插一些分布式的基本原理，但是不会展开。如果读者有兴趣，可以自行查阅本网站的其他文章。</p><h2 id="_3-微服务架构概述" tabindex="-1"><a class="header-anchor" href="#_3-微服务架构概述" aria-hidden="true">#</a> 3. 微服务架构概述</h2><p>架构主要分为三种架构类型，这三种架构类型分别是：应用架构、业务架构、技术架构，业务架构决定了应用架构，技术架构支撑了应用架构。架构的发展经历了三个阶段：单体应用到分布式架构、分布式架构到soa架构、soa架构到微服务架构。</p><p>早期的单体应用架构的缺点：</p><ul><li>所有的功能都集中在一个应用中；如果业务复杂会造成，整个应用的代码量很大；</li><li>模块之间界限不明，导致模块与模块之间的耦合度很高；</li><li>出现某一个小错误，就会造成整个应用的不可启动；</li><li>团队成员之间的协作灵活性较差：模块a可能依赖模块b，a开发完成后，需要等待b的开发；</li><li>很可能要求开发人员前后端同时开发，这对开发人员的技术功力要求很大；</li><li>很容易造成前后端责任界限不够清晰，比如有可能会在前端进行业务处理；</li></ul><p>分布式架构的特点：</p><ul><li>按照业务进行垂直划分，简单来讲，就是把原来的单体应用划分成多个应用，每一个应用都是一个单体应用，通过api相互调用来实现整体的应用的功能；</li></ul><p>SOA架构与微服务架构的区别：</p><ul><li>todo</li></ul><p>微服务架构的一些常见功能：</p><ul><li>服务注册与发现</li><li>负载均衡</li><li>熔断与容错</li><li>配置中心</li><li>网关与链路监控</li></ul><h2 id="_4-springcloud与中间件" tabindex="-1"><a class="header-anchor" href="#_4-springcloud与中间件" aria-hidden="true">#</a> 4. SpringCloud与中间件</h2><p>学习策略：本章节主要包括了SpringCloud中间件与其他中间件之间的关系，中间件解决了在企业级应用开发过程中遇到的哪些困难，中间件产生的背景、中间件的功能、以及Springcloud针对这些中间件的具体实现。</p><h3 id="_4-1-中间件概述" tabindex="-1"><a class="header-anchor" href="#_4-1-中间件概述" aria-hidden="true">#</a> 4.1. 中间件概述</h3><p>以前的中间件与操作系统和数据库并列为传统基础软件的三家马车，是运行在操作系统之上、应用软件之下的“中间层”的软件。但是随着云计算的发展，软件大规模向互联网云服务进行演化，中间件在整个过程中也不断扩大和演进自己的边界。中间件开始向下屏蔽异构的硬件设备、软件和网络等计算资源，向上提供应用、运行、维护等全生命周期的统一计算环境与管理。常见的中间件有：服务治理中间件、配置中心、全链路监控、分布式事务、分布式定时任务、消息中间件、api网关、分布式缓存、数据库中间件等。</p><h3 id="_4-2-springcloud概述" tabindex="-1"><a class="header-anchor" href="#_4-2-springcloud概述" aria-hidden="true">#</a> 4.2. SpringCloud概述</h3><p><code>本质上是一个中间件、目前由spring官方维护，基于SpringBoot开发，实现了微服务架构思想的一套中间件产品。</code>它提供了一系列的组件功能，如服务注册与发现（eureka、consul）、配置中心（config、nacos）、全链路监控（sleuth）、api网关（zuul、gateway、）、熔断器（hystrix）等选型中立（不依赖于平台和技术）的开源组件。每个独立的组件都有各自的软件版本，所有的组件合并成一个SpringCloud的版本，版本号由伦敦地铁站字母序命名。</p><h3 id="_4-3-springcloud与服务治理中间件" tabindex="-1"><a class="header-anchor" href="#_4-3-springcloud与服务治理中间件" aria-hidden="true">#</a> 4.3. SpringCloud与服务治理中间件</h3><p>服务治理中间件的基本功能包括以下内容。</p><ul><li>服务治理 <ul><li>服务注册与发现（Eureka、zk、consul）</li><li>服务路由 <ul><li>服务上下线</li><li>在线测试</li><li>机房就近选择</li><li>ab测试</li><li>灰度发布</li></ul></li><li>负载均衡 <ul><li>根据目标状态和目标权重进行负载均衡</li></ul></li><li>自我保护 <ul><li>服务降级</li><li>优雅降级</li><li>流量控制</li></ul></li></ul></li><li>丰富的治理管理机制</li></ul><h3 id="_4-4-springcloud与配置中心中间件" tabindex="-1"><a class="header-anchor" href="#_4-4-springcloud与配置中心中间件" aria-hidden="true">#</a> 4.4. SpringCloud与配置中心中间件</h3><p>配置中心产生的原因：在单体应用中 ，我们一般会把属性配置和代码硬编码到一起，但在分布式系统中，由于会存在多个服务实例，因此就需要管理每一个具体服务工程中的配置，上线前也需要checklist并逐个检查每一个上线的服务是否配置正常，且如果系统一旦上线，需要修改某项配置，就需要重启服务。这样管理起来非常麻烦。因此配置中心应运而生。</p><p>要求配置中心具有的功能有： 面向全公司（要求支持不同语言的应用接入）、要求与公司运维体系进行集成、要求对权限进行管理、要求对已有的配置中心进行兼容。</p><p>具体的实现有SpringCloud config和携程开源的配置中心Apollo。</p><h3 id="_4-5-springcloud与网关中间件" tabindex="-1"><a class="header-anchor" href="#_4-5-springcloud与网关中间件" aria-hidden="true">#</a> 4.5. SpringCloud与网关中间件</h3><p>出现在系统边界上的一个面向api、串行集中式的强管控服务，可以理解为企业级应用防火墙，主要起到隔离外部应用和内部应用的作用。</p><p>要求网关中间件具备的几个功能：</p><ul><li>统一接入功能 <ul><li>为各个无线应用提供统一的接入服务，提供一个高性能、高并发、高可靠的网关服务。还需要支持负载均衡、容灾切换、异地多活。</li></ul></li><li>协议适配功能 <ul><li>针对不同的后端提供的不同的服务协议进行适配。比如当一个http请求经过网关后，通过一系列不同的fitter进行处理完毕后，需要进行协议适配，然后判断协议转发调用的到底是rpc服务还是rest服务或者是php提供的服务。</li></ul></li><li>流量管控功能 <ul><li>网关作为所有请求流量的入口，当流量瞬间剧增，需要进行流量管控、流量调拨，服务不可用时，还需要网关进行熔断和降级。在异地多活场景下，还需要对流量进行切片，路由到不同的机房。</li></ul></li><li>安全防护功能 <ul><li>对所有的请求进行安全防护过滤，保护后端服务。还可以通过与安全风控部门进行合作，对ip黑名单、URL和名单封禁控制，做风控防护、防止恶意攻击等。</li></ul></li></ul><p>Springcloud中的网关</p><ul><li>zuul： qps很低，原理是针对每一个请求都分配一个线程来处理，qps最多一两千，高并发场景下，不推荐；</li><li>gateway： 底层是基于netty的多线程reactor模型实现，使用boss线程和worker线程接受异步处理请求，具有很强的高并发处理能力；</li></ul><h3 id="_4-6-springcloud与全链路监控中间件" tabindex="-1"><a class="header-anchor" href="#_4-6-springcloud与全链路监控中间件" aria-hidden="true">#</a> 4.6. SpringCloud与全链路监控中间件</h3><p>一个通过浏览器或移动客户端的前端请求到后端应用，会经过很多应用系统，并留下足迹和相关日志信息。但是这些分散到每一个业务主机下的日志不利于问题排查和问题定位。此时全链路监控中间件就应运而生。全链路监控中间件主要功能应该包括：</p><ul><li>定位慢调用</li><li>定位各种错误和异常</li><li>实现依赖和拓扑</li><li>追踪调用链</li><li>应用告警</li></ul><p>springcloud中的全链路监控中间件： pinpoint、skywalking等。</p><h2 id="_5-springcloud增强生态" tabindex="-1"><a class="header-anchor" href="#_5-springcloud增强生态" aria-hidden="true">#</a> 5. SpringCloud增强生态</h2><p>上述章节中介绍了微服务架构中遇到的一些问题以及微服务架构过程中所出现的一些技术，以及Springcloud基于这些问题所做的一些实现。 但是这些还不够。还有一些问题需要解决：</p><ul><li>单体应用拆分后，进程间通信机制和故障处理措施变的更加复杂；</li><li>微服务化后，一个看似简单的功能，可能需要调用多个服务并操作多个数据库才能实现，这就使得分布式事务问题变得异常突出；</li><li>微服务数量众多，测试、部署和监控问题变得更加困难；</li></ul><p>针对第一个问题，随着RPC框架的成熟，已经得到解决；Docker、Devops技术的发展以及各公有云Paas平台自动化运维工具的推出，第三个问题也变得很容易；唯独第二个问题还是一件具有挑战性的问题。</p><p>针对第一个问题，可以使用SpringCloud和gRPC进行集成，也可以使用SpringCloud与Dubbo生态的融合（如：spring-clod-dubbo项目，就是把dubbo融入SpringCloud生态，使微服务调用同时具备RESTful和Dubbo调用的能力，做到对业务代码无侵入、无感知，如果使用过程中引入jar包，就在服务调用间使用dubbo，如果去掉jar包，则使用默认的RESTful）。</p><p>归根结底，SpringCloud是技术上的一种架构，只是解决了架构层面的问题，但对于业务怎么开发、业务架构怎么治理、架构怎么防腐、如何解决应用架构间的复杂性问题，还需要方法论指导，此时，引入DDD面向领域设计模型的指导思想。</p><h2 id="_6-eureka服务治理" tabindex="-1"><a class="header-anchor" href="#_6-eureka服务治理" aria-hidden="true">#</a> 6. eureka服务治理</h2><h3 id="服务发现的由来" tabindex="-1"><a class="header-anchor" href="#服务发现的由来" aria-hidden="true">#</a> 服务发现的由来</h3><h4 id="从架构部署的角度" tabindex="-1"><a class="header-anchor" href="#从架构部署的角度" aria-hidden="true">#</a> 从架构部署的角度</h4><p><code>单体架构</code>应用的服务自成一体，大多不需要以来其他外部服务，但是有些也需要依赖外部服务，此时使用配置域名的方式，直接访问即可。</p><p>到了<code>soa架构时代</code>，服务化的架构内部依赖比较多，主要通过两种方式实现服务发现：</p><ol><li>服务消费者配置服务生产者的upstream。这样的缺点是服务消费者耦合了服务生产者的实现细节，例如，服务生产者需要添加一台主机，那么就需要服务消费者修改配置。</li><li>服务生产者提供统一的内网域名。这样，如果服务生产者需要添加一台主机，只需要在自己的前置机上添加一个ip地址即可。</li></ol><p>再往后发展，到了<code>微服务时代</code>，随着docker的流行，底层运维方式发生了巨大变化，业务不在部署在固定的虚拟机上，ip也不会一成不变。这时候，前面的方案就有些捉襟见肘了。但针对这个问题，不同的思考方式提供了不同的解决方案，下面列举几个：</p><ol><li>以ng为例，直接手工或通过脚本方式，在部署的时候直接更新ng的配置文件，然后在reload。或者是使用ngx_http_dyups_module通过rest api在运行时直接更新upstream，而不需要reload。</li><li>直接把服务注册中心作为一个标配的分布式服务组件引入系统，网关组件从服务注册中心获取相关服务的示例信息，从而达到动态路由。</li></ol><h4 id="从开发实现的角度" tabindex="-1"><a class="header-anchor" href="#从开发实现的角度" aria-hidden="true">#</a> 从开发实现的角度</h4><p>随着架构的发展，单体应用逐步过渡为微服务应用，服务之间的依赖会越来越多。假设团队b、c、d的服务需要团队a的服务提供接口，那么团队a中的服务就需要提供给团队b、c、d一个接口地址，此时如果团队b需要团队a提供一个新的接口地址，那么团队a就需要修改代码，同时团队c或d也需要提供一个新的接口地址，则团队a同样需要修改代码。就会出现这样的情况：就是不管团队b、c、d哪一个消费者需要增加一个接口或修改一个接口甚至弃用一个接口，抑或是团队a的项目需要进行扩容，都需要团队a修改自己的代码，这就造成了核心系统频繁修改代码。这其实是一个强耦合的关系，但是如果引入服务发现组件，团队b、c、d只需要与服务发现组件进行连接，即可获取团队a的代码，这样就可以达到解耦的目的。同时，不论团队a的服务扩容还是缩容，对b、c、d都不会产生过多影响。</p><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h4><p>服务发现组件出现的主要目的是为了解决服务与服务间过多依赖形成强耦合关系的问题。随着技术不断演进，服务发现组件的功能也在不断增强，服务组册、服务监测、服务路由、负载均衡、自我保护等功能被引进来，也就逐步形成了服务治理组件的全部功能。</p><h2 id="springcloud-eureka简介" tabindex="-1"><a class="header-anchor" href="#springcloud-eureka简介" aria-hidden="true">#</a> SpringCloud Eureka简介</h2><h4 id="产生" tabindex="-1"><a class="header-anchor" href="#产生" aria-hidden="true">#</a> 产生</h4><p>由netflix公司开源，是为了解决aws不提供中间服务层的负载均衡问题而设计开发的。可以提供负载均衡、failover等支持。之所以产生eureka组件，而不使用原有的AWS Elastic Load Balancer，是因为WS Elastic Load Balancer需要暴露地址给外网，这样造成不安全的问题。另外一方面是因为，WS Elastic Load Balancer是基于代理的负载均衡，无法直接基于服务元数据信息定制负载均衡算法。由此就产生了eureka。</p><h4 id="技术选型" tabindex="-1"><a class="header-anchor" href="#技术选型" aria-hidden="true">#</a> 技术选型</h4><p>主要介绍consul与eureka的区别。eureka服务端采用的是p2p的复制模式，不能保证复制操作一定能成功，它提供的是最终一致性的服务实例视图；客户端在服务端的注册信息有一个带期限的租约信息，一旦服务端在指定期限内没有收到客户端的心跳，则服务端就认为客户端组册的服务是不健康的，定时任务就会把客户端组册的服务剔除。consul采用的是raft算法，可以提供强一致性保证，并且consul的agent相当于ribbon和eureka客户端，对应用相对透明，同时相对eureka的集中式心跳检测机制，consul的agent可以参与到基于gossip协议的健康检查，这样分散了服务端的心跳检测压力。此外，eureka是由java编写，consul由go编写；eureka支持ap，consul支持cp。</p><p>但是如果团队选择的是ap，不是cp，并且团队是java语言体系，对组件的掌控力较强，则可以使用eureka。此外，eureka还提供了restful风格的api，可以针对注册到eureka上的服务进行操作。</p><h4 id="入门案例" tabindex="-1"><a class="header-anchor" href="#入门案例" aria-hidden="true">#</a> 入门案例</h4><ul><li>创建pom工程，引入SpringCloud、SpringBoot-starter的相关依赖。</li><li>创建eureka服务器端工程。 <ul><li>引入依赖</li><li>创建主启动类，并在主启动类中添加@EnableEurekaServer注解，以打开服务器端服务注册开关</li><li>修改配置文件，设置serviceUrl路径以及其他信息</li></ul></li><li>创建服务生产者工程。 <ul><li>引入依赖</li><li>创建主启动类，并在主启动类中添加@EnableDiscoveryClient注解，打开客户端服务注册开关</li><li>修改配置文件，设置serviceUrl路径信息与eureka服务器端工程一致</li><li>书写业务代码，给服务消费者提供服务</li></ul></li><li>创建服务消费者工程。 <ul><li>引入依赖</li><li>创建主启动类，并在主启动类中添加@EnableDiscoveryClient注解，打开客户端服务注册开关</li><li>修改配置文件，设置serviceUrl路径信息与eureka服务器端工程一致</li><li>书写业务代码，调用服务消费者提供的服务</li></ul></li></ul><p>此过程不全，需要进行完善。需要补充服务消费者调用服务生产者的配置和调用代码。</p><h4 id="rest-api" tabindex="-1"><a class="header-anchor" href="#rest-api" aria-hidden="true">#</a> REST API</h4><ul><li>查询实例 <ul><li>查询所有应用实例信息</li><li>根据appid查询实例信息</li><li>根据appid及instanceid查询实例信息</li><li>根据instanceid查询实例信息</li></ul></li><li>操作实例 <ul><li>注册新实例</li><li>注销实例</li><li>暂停、下线实例</li><li>恢复实例</li><li>发送应用实例心跳数据</li><li>修改实例元数据</li></ul></li></ul><h3 id="源码" tabindex="-1"><a class="header-anchor" href="#源码" aria-hidden="true">#</a> 源码</h3><h4 id="核心类" tabindex="-1"><a class="header-anchor" href="#核心类" aria-hidden="true">#</a> 核心类</h4><ul><li>InstanceInfo：注册的服务实例</li><li>LeaseInfo：实例的租约信息</li><li>ServiceInstance：服务的通用信息</li><li>InstanceStatus：服务实例的状态信息</li><li>LeaseManager：此接口定义了应用服务实例在服务中心的几个操作方法。</li><li>LookupService：此接口定义了客户端从服务中心获取服务实例的查询方法</li><li>InstanceRegistry：</li><li>AbstractInstanceRegistry</li><li>PeerAwareInstanceRegistryImpl</li><li>。。。</li></ul><h4 id="服务的核心操作" tabindex="-1"><a class="header-anchor" href="#服务的核心操作" aria-hidden="true">#</a> 服务的核心操作</h4><ul><li>register</li><li>cancel</li><li>renew</li><li>evict</li></ul><h4 id="eureka的设计理念" tabindex="-1"><a class="header-anchor" href="#eureka的设计理念" aria-hidden="true">#</a> Eureka的设计理念</h4><ul><li>服务实例如何注册到服务中心 <ul><li>本质是服务启动时，调用Eureka Server的REST api的register方法，去注册该应用实例的信息。有两种方法，对java应用程序，可以使用Netflix的Eureka Client封装的API调用注册；对于SpringCloud的应用，可以使用spring-cloud-starter-netflix-eureka-client，基于SpringBoot的自动化配置，自动实现服务信息的注册。</li></ul></li><li>服务实例如何从服务中心剔除 <ul><li>正常情况下服务实例在关闭应用时，通过钩子的方法或者生命周期回调方法去调用EurekaServer的RESTApi的de-register方法，来剔除自身服务实例的信息。此外为了解决服务实例挂掉或者其他异常信息导致没有及时剔除自身信息的问题，EurekaServer会要求Client端定时续约，即发送心跳，来证明实例实例是正常的，如果租约超过一定时间没有进行续约操作，Eureakserver就会进行自动删除。</li></ul></li></ul><h3 id="总结-1" tabindex="-1"><a class="header-anchor" href="#总结-1" aria-hidden="true">#</a> 总结</h3><p>由架构发展演进过程引入服务发现组件，通过Netflix公司开源其自研的服务发现组件eureka来介绍服务发现组件的主要实现技术，由此引入eureka的应用案例，并简单介绍了eureka的其他特性。此外，还添加了eureka和其他同类产品的对比。</p><h2 id="_7-spring-cloud使用apollo作为配置中心" tabindex="-1"><a class="header-anchor" href="#_7-spring-cloud使用apollo作为配置中心" aria-hidden="true">#</a> 7. Spring Cloud使用Apollo作为配置中心</h2><h3 id="_1-apollo部署及使用过程" tabindex="-1"><a class="header-anchor" href="#_1-apollo部署及使用过程" aria-hidden="true">#</a> 1. apollo部署及使用过程</h3><h4 id="_1-1-部署过程" tabindex="-1"><a class="header-anchor" href="#_1-1-部署过程" aria-hidden="true">#</a> 1.1. 部署过程</h4><ol><li>下载三个zip包，并解压</li><li>导入数据库</li><li><s>创建eureka服务</s></li><li><s>修改数据库中apolloconfigdb.serverconfig表中 eureka.service.url 的值为eureka的地址</s></li><li>依次启动 config 、 admin、 portal 服务</li><li>检查8080端口占用情况，如果被占用启动时会报错，8080是config所在服务的端口</li></ol><h4 id="_1-2-使用" tabindex="-1"><a class="header-anchor" href="#_1-2-使用" aria-hidden="true">#</a> 1.2. 使用</h4><h5 id="_1-2-1-配置apollo" tabindex="-1"><a class="header-anchor" href="#_1-2-1-配置apollo" aria-hidden="true">#</a> 1.2.1. 配置Apollo</h5><p>管理台地址的端口为： 8070</p><p>初始化用户名密码为： apollo / admin</p><ol><li>创建项目</li><li>创建配置项</li><li>发布</li></ol><h5 id="_1-2-2-在项目中使用" tabindex="-1"><a class="header-anchor" href="#_1-2-2-在项目中使用" aria-hidden="true">#</a> 1.2.2. 在项目中使用</h5><ol><li>在项目的pom中引入Apollo的客户端</li><li>在项目的application.yml文件中添加：</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>apollo:
  bootstrap:
    enabled: true
    namespaces: application
  meta: http://192.168.1.150:8080 # 此地址为config服务所在的地址

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>添加app.properties文件</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app.id=XXXX

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>创建配置文件</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Configuration
@EnableApolloConfig(value = &quot;application&quot;, order = 10)
public class AppConfig {
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>创建配置项并使用</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@RestController
@RequestMapping(&quot;configConsumer&quot;)
@RefreshScope
public class ConfigClientController {

    @Value(&quot;\${config_info}&quot;)
    private String config;

    @RequestMapping(&quot;/getConfigInfo&quot;)
    public String getConfigInfo(){
        return config;
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-注意事项" tabindex="-1"><a class="header-anchor" href="#_1-3-注意事项" aria-hidden="true">#</a> 1.3. 注意事项</h4><ol><li>在部署后，在web控制台进行配置时，创建了一个项目，如果遇到报错信息： 请联系管理员 等信息，可以去找对应服务的启动文件，启动文件中有日志所在的地址，查看日志即可得知哪里出了问题；如果是端口占用，可以使用 netstat -nultp 命令查看端口占用情况。</li><li>项目启动后，发现一直报错，应先考虑配置文件是否有误。注意： apollo.meta 地址是config服务所在的地址，不要写错。</li><li>configuration 项目和 administer 项目依赖eureka，端口是8080，要看看此端口是否已经被占用。</li></ol><h4 id="_1-4-参考" tabindex="-1"><a class="header-anchor" href="#_1-4-参考" aria-hidden="true">#</a> 1.4. 参考</h4>`,107),ns={href:"https://blog.csdn.net/SIMBA1949/article/details/107561778",target:"_blank",rel:"noopener noreferrer"},ss={href:"https://www.apolloconfig.com/#/zh/README",target:"_blank",rel:"noopener noreferrer"},as=t(`<hr><h3 id="_2-把application-yml文件整体放入apollo" tabindex="-1"><a class="header-anchor" href="#_2-把application-yml文件整体放入apollo" aria-hidden="true">#</a> 2. 把application.yml文件整体放入apollo</h3><h4 id="_2-1-项目背景" tabindex="-1"><a class="header-anchor" href="#_2-1-项目背景" aria-hidden="true">#</a> 2.1. 项目背景</h4><p>把springboot项目中的application.yml文件，整个都放入Apollo中，启动时项目先从Apollo中获取配置文件，然后根据拉取的配置文件进行启动。这样可以达到配置文件保密的效果。</p><h4 id="_2-2-添加依赖" tabindex="-1"><a class="header-anchor" href="#_2-2-添加依赖" aria-hidden="true">#</a> 2.2. 添加依赖</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
	&lt;groupId&gt;com.ctrip.framework.apollo&lt;/groupId&gt;
	&lt;artifactId&gt;apollo-client&lt;/artifactId&gt;
	&lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-添加注解" tabindex="-1"><a class="header-anchor" href="#_2-3-添加注解" aria-hidden="true">#</a> 2.3. 添加注解</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@EnableApolloConfig

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-发布配置文件内容" tabindex="-1"><a class="header-anchor" href="#_2-4-发布配置文件内容" aria-hidden="true">#</a> 2.4. 发布配置文件内容</h4><p>使用 <a href="">http://www.toyaml.com/index.html</a> 把yml格式转成properties格式。然后复制出所有的配置项，复制到Apollo管理页面上进行发布。</p><h4 id="_2-5-修改配置文件" tabindex="-1"><a class="header-anchor" href="#_2-5-修改配置文件" aria-hidden="true">#</a> 2.5. 修改配置文件</h4><p>注释掉之前所有的配置项，只添加下面内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>app:
  id: 103929
apollo:
  bootstrap:
    enabled: true
    namespaces: application

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-创建本地缓存目录" tabindex="-1"><a class="header-anchor" href="#_2-6-创建本地缓存目录" aria-hidden="true">#</a> 2.6. 创建本地缓存目录</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd /opt
sudo mkdir /opt/data
sudo chmod -R 777 data
sudo mkdir /opt/settings
cd settings
sudo touch server.properties
sudo vi server.properties

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 server.properties 文件中添加:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>env=DEV
apollo.meta=http://192.168.1.150:8080

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-7-启动后进行验证" tabindex="-1"><a class="header-anchor" href="#_2-7-启动后进行验证" aria-hidden="true">#</a> 2.7. 启动后进行验证</h4><p>成功</p><h4 id="_2-8-注意事项" tabindex="-1"><a class="header-anchor" href="#_2-8-注意事项" aria-hidden="true">#</a> 2.8. 注意事项</h4><ol><li>创建本地目录是重要的步骤，不能省略，否则项目启动时会自己初始化，不会拉取Apollo的配置，创建完目录后还需要保证目录的读取权限。</li><li>创建完本地目录后还需要创建 server.properties 文件，用来指定运行的环境。</li><li></li></ol><h4 id="_2-9-参考地址" tabindex="-1"><a class="header-anchor" href="#_2-9-参考地址" aria-hidden="true">#</a> 2.9. 参考地址</h4>`,22),es={href:"https://blog.csdn.net/qq_20042935/article/details/104262790",target:"_blank",rel:"noopener noreferrer"},ts={href:"https://www.bookstack.cn/read/ctripcorp-apollo/spilt.2.5e3f6033aee666be.md#1.5%20%E5%BA%94%E7%94%A8%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE",target:"_blank",rel:"noopener noreferrer"},is=t('<hr><h3 id="_3-修改本地缓存的配置文件的目录地址" tabindex="-1"><a class="header-anchor" href="#_3-修改本地缓存的配置文件的目录地址" aria-hidden="true">#</a> 3. 修改本地缓存的配置文件的目录地址</h3><p>大多数公司里面的开发机都是经过部署过的，很多目录并没有读写权限，并且很多大厂内的电脑多是需要自己的账号登陆的，因此，可以把Apollo的本地缓存地址放置到用户自己的Home目录下。此外，由于配置中心的私密性，并且都是内网环境，因此还把Apollo的配置配置地址隐藏掉。这样只需要在家目录下放置 .settings.xml 文件，里面只需要指定环境即可。</p><h2 id="_8-nacos服务注册" tabindex="-1"><a class="header-anchor" href="#_8-nacos服务注册" aria-hidden="true">#</a> 8. nacos服务注册</h2><p>服务治理包括主要包括<code>服务的注册与发现</code>、<code>服务监控</code>、<code>服务管控</code>等功能，是目前微服务架构中必不可少的基础组件。其中服务注册与发现是服务治理组件的功能特性，而服务的监控、服务的管控等则是服务治理组件的较为高阶的功能特性。本文中，笔者主要介绍服务的<code>注册与发现功能</code>。</p><h3 id="_1-为什么需要服务治理" tabindex="-1"><a class="header-anchor" href="#_1-为什么需要服务治理" aria-hidden="true">#</a> 1. 为什么需要服务治理</h3><blockquote><p>一种技术不会平白无故的产生，它的产生一定是为了解决某个问题。而要想了解具体是解决了什么问题，就必须要从技术迭代的过程中去发现。</p></blockquote><p>微服务架构中，由于有众多的微服务模块，而服务模块与服务模块中大多有相互调用的关系。传统的SOA或ESB类型的项目中的模块之间的调用关系是通过以下两种方式进行调用：</p><ol><li><code>项目中硬编码</code>。比如a模块需要调用b模块，那就在a模块中的配置文件中添加一个配置项，配置上b模块的服务地址。这种方式有一个问题，那就是当一个b模块的地址发生改变时，就需要改变a模块中的配置项，还需要重新部署a模块。这种方式违背了“开闭原则”，并且如果不同团队分别负责a、b模块，修改b模块，要引起a模块的修改，也会导致不同团队的相互“扯皮”。</li><li><code>使用nginx代理</code>。b模块的服务地址由nginx进行代理，对外暴露的是一个域名地址。但这种方案势必要求每次b模块修改地址，运维人员就要修改nginx的配置，也同样会违背广义上的“开闭原则”，也同样会导致开发团队与运维团队的相互“扯皮”。</li></ol><p>从上面的两中传统调用方式来看，所谓的服务注册与发现功能，就是<code>服务提供者通过某种机制把自身信息提供出去，再使用某种机制提供给服务消费者</code>——这就是服务注册与发现的核心概念。</p><h3 id="_2-前置知识" tabindex="-1"><a class="header-anchor" href="#_2-前置知识" aria-hidden="true">#</a> 2. 前置知识</h3><p>要想了解服务治理的相关内容，还需要了解到分布式系统的相关概念，如 <code>CAP原理</code> 、 <code>Paxos算法</code> 、 <code>Raft算法</code> 等，可以参考《<code>从PAXOS到ZOOKEEPER 分布式一致性原理与实践》</code>一书。此处不再赘述。</p><h3 id="_3-注册中心选型" tabindex="-1"><a class="header-anchor" href="#_3-注册中心选型" aria-hidden="true">#</a> 3. 注册中心选型</h3>',13),ls={href:"https://mp.weixin.qq.com/s/AUHY3nKZqDbAhkfebOPWCg",target:"_blank",rel:"noopener noreferrer"},ps=t('<p>在Java领域中大概有这么几种服务治理中心：Zookeeper 、 Eureka 、 Consul 、 Nacos 。下面简单介绍一下这几种服务治理的相关组件。</p><h4 id="_3-1-zookeeper" tabindex="-1"><a class="header-anchor" href="#_3-1-zookeeper" aria-hidden="true">#</a> 3.1. Zookeeper</h4><p>Zookeeper（以下简称： ZK）是分布式应用中一个非常重要的组件，主要是实现了 Paxos 算法，也是因为它实现了分布式系统中这一重要的算法，所以它的应用很广，不但可以利用它作为服务的注册中心，也可以用它作为服务的配置中心。此外，它是一个独立的第三方组件，可以像mysql一样安装在服务器上，然后业务程序通过不同实现的客户端组件来操作ZK的API，这也使得它能够应用于多种编程语言。</p><p>ZK中的节点的角色：</p><ul><li><code>Leader</code> ：启动时集群环境中会选择某一个节点作为Leader节点，并由这个Leader节点负责发起投票和决议，还负责维护其余各节点的心跳信息。此外，客户端的写操作信息也由Leader节点通过广播的形式向其他节点进行传播</li><li><code>Follower</code> ：集群启动时，Leader选定之后，剩余的节点为Follower节点，这些节点可以响应Leader节点的心跳，还可以响应客户端的读请求，同时要把客户端的写请求转发给Leader。此外，当Leader节点发生异常不能对外提供服务时，Follower节点会参与投票选举，从而产生新的Leader节点</li><li><code>Observer</code> ： 不参与投票过程，可以响应读请求，但写请求依然会转发给Leader；</li></ul><p>ZK中的节点类型：</p><ul><li><code>持久节点</code>：一旦创建之后就一直存在，直到被删除；</li><li><code>临时节点</code>：只能作为叶子节点，生命周期与客户端会话进行绑定，会话结束后消失；</li><li><code>持久顺序节点</code>：除了具有持久节点的特性外，还具有顺序性，如： /node1/app000001 、 /node1/app000002 ；</li><li><code>临时顺序节点</code>：除了具有临时节点的特性外，还具备顺序性；</li></ul><p>ZK中的Watch机制：</p><ul><li>这种机制有点类似于轻量级的发布订阅机制，之所以说是轻量级的，是因为ZK一旦感知到存储的数据发生改变，ZK服务端便会发送包括事件类型和节点信息的给到相关的客户端，当客户端接收到后，主动请求ZK来读取变更的数据。</li></ul><p>ZK作为注册中心：</p><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>举个例子，假如a服务调用b服务，b服务在启动时就会通过客户端软件，把自身信息写到ZK中去（如上图中8080端口的节点数据），当a服务执行调用过程时，就会通过客户端软件，读取到ZK中的b服务的相关节点信息，然后完成调用过程。</p><p>需要注意的是：</p><ol><li>a、b服务在调用过程中，都是通过客户端软件与ZK进行通信的；服务注册时，服务提供者把自身信息写到ZK中；服务发现时，服务消费者从ZK中读取信息；</li><li>ZK中读取数据的流程就是树形节点的遍历过程，因此服务消费者读取到的服务提供者的数据大概是这样的：<code>/myOrgGroup/product/providers/192.1681.1.100:8080</code>， <code>/myOrgGroup/product/providers/192.1681.1.101:8080</code>，...</li><li>叶子节点作为服务具体信息的存储节点，也是临时节点，由于是临时节点，因此当服务提供者因会话超时或发生异常无法响应时，这个临时节点就会被ZK剔除，剔除后ZK又通过Watch机制通知到相关的服务消费者，这样就做到了服务消费者信息的及时更新；</li><li>ZK并不保证可用性，因为在设计之初，就遵循CP原则，也就是任意时刻访问ZK，响应结果都是一致的。但当ZK集群中Leader发生异常无法对外提供服务，或者，整个ZK集群中超过半数以上的服务节点不可用，那么整个集群就无法对外提供服务了。</li></ol><h4 id="_3-2-eureka" tabindex="-1"><a class="header-anchor" href="#_3-2-eureka" aria-hidden="true">#</a> 3.2. Eureka</h4><p>在SpringCloud的Netflix的早期版本中，Eureka主要承担服务注册与发现的功能。目前好像在憋什么大招，更新频率较低。</p><p>Eureka的业务架构中把Eureka的客户端和服务端分成三种角色信息，主要包括 Server 、 Provider 、 Consumer 三个角色。</p><ol><li>Server ： 主要提供服务的注册与发现功能，也就是 Eureka 的服务端；</li><li>Provider ： Eureka 的客户端，主要负责服务的注册功能，把自身的服务信息注册到Eureka的服务端；</li><li>Consumer ： Eureka 的客户端，从Eureka的服务端获取服务提供者的服务信息；</li></ol><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Server服务端通过设计多个实例彼此相互注册，形成一个去中心的架构，由于注册方式是通过p2p的通信协议进行的，因此节点与节点之间的身份相同，没有主从之分；节点与节点之间通过心跳契约的方式检查集群节点的健康状况，默认情况下，集群在一定时间内没有收到某一个节点的心跳信息，就会自动注销该节点；当新的节点启动时，会先从集群中获取所有的其他节点信息，然后再把应用服务节点的注册信息同步过来，之后对外提供服务；在应用服务进行注册时， Provider 应用和 Consumer 应用会把注册信息写入Eureka集群中某一节点，之后Eureka会把信息同步复制到其他所有节点，达到所有节点中数据的同步一致；应用服务进行消费时， Consumer 应用会从集群中任一节点中读取到 Consumer 应用的注册信息，然后进行远程调用。</p><p>由于在Eureka设计之初，就遵循AP原则，也就是保证高可用。这样设计的结果就是Eureka集群中，只要有一个节点存活，就可以对外提供服务。这种方式得益于Eureka的自我保护机制。如果15分钟内，85%的集群节点都没有正常的心跳，此时可以认为客户端与Eureka出现了网络故障，Eureka集群就会进入自我保护机制；之后Eureka不再剔除因为长时间没有收到心跳的服务，但是仍然可以接受新服务的注册与发现，但是不会再同步给其他Eureka节点，当网络稳定后，在把应用服务的注册信息同步复制给其他节点。</p><h4 id="_3-3-consul" tabindex="-1"><a class="header-anchor" href="#_3-3-consul" aria-hidden="true">#</a> 3.3. Consul</h4><p>Consul是一种基于服务网格的分布式服务治理方案，提供服务注册与发现、分布式配置、健康检查和负载均衡的功能。此外，它还支持多个数据中心的高可用方案。</p><p>Consul的所有节点都称为Agent节点，这些节点根据功能分为Client和Server两类。其中Server节点负责保存数据和响应Client的请求，分为Leader节点和Follower节点，当Consul集群启动时，所有节点启动成功后，会通过Gossip协议进行通信，同时也会选举产生一个Leader节点；当有应用服务注册到集群时，当Leader节点收到注册信息之后会把数据同步给其他Follower节点，当Follower节点收到注册信息时，会通过RPC转发给集群中Leader节点，再有Leader节同步给其他Follower节点；当Leader节点发生异常无法对外提供服务时，Follower节点会重新选举产生一个Leader节点。</p><h4 id="_3-4-nacos" tabindex="-1"><a class="header-anchor" href="#_3-4-nacos" aria-hidden="true">#</a> 3.4. Nacos</h4><p>Nacos是阿里巴巴开源的一个分布式组件，也是本篇文章的主要内容。它具有很多的优良特性：</p><ul><li>服务注册与发现与服务的健康检测： 支持基于DNS和基于RPC的服务发现，同时能够对服务提供实时的健康监测，阻止向不健康的服务实例发送请求；</li><li>动态配置管理： 能够以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置；</li><li>动态DNS服务： 支持权重路由，更便捷的实现中间层的负载均衡、更灵活的路由配置策略、流量控制以及数据中心内网的简单DNS解析；</li><li>服务的元数据管理： 支持管理所有服务及其元数据，包括服务描述、生命周期、静态依赖分析、健康监测、流量控制、路由策略、metrics统计数据等；</li></ul><p>此外，Nacos还配备有易用的控制台页面、权限控制系统及AP/CP的切换。Nacos还具有良好的生态系统：</p><figure><img src="'+r+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_4-实战演练" tabindex="-1"><a class="header-anchor" href="#_4-实战演练" aria-hidden="true">#</a> 4. 实战演练</h3><blockquote><p>微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。</p></blockquote><p>创建两个服务，一个是服务提供者（provider），一个是服务消费者（consumer），让两个服务都注册到nacos服务器上，然后让服务消费者调用服务提供者的接口。</p><p>第一步，我们要先搭建nacos的服务；第二步，我们创建两个服务，并配置好注册的nacso的服务地址；第三步，在服务提供者服务中提供一个接口供服务消费者进行调用，之后再在服务消费者服务中提供一个接口来调用服务提供者提供的接口。下面我们开始进行实战。</p><h4 id="_4-1-安装nacos服务" tabindex="-1"><a class="header-anchor" href="#_4-1-安装nacos服务" aria-hidden="true">#</a> 4.1. 安装nacos服务</h4><blockquote><p>nacos服务依赖jdk开发环境，请先行安装jdk的环境。</p></blockquote><p>CentOS7.9安装过程如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>// 下载
<span class="token comment"># wget https://github.com/alibaba/nacos/releases/download/1.2.1/nacos-server-1.2.1.tar.gz</span>

// 解压到安装目录
<span class="token comment"># tar zxvf nacos-server-1.2.1.tar.gz -C /usr/setup/</span>
// 进入bin目录，启动
<span class="token comment"># ./startup.sh -m standalone</span>

// 开放端口
<span class="token comment"># firewall-cmd --zone=public --add-port=8848/tcp --permanent</span>
<span class="token comment"># firewall-cmd --reload</span>


// <span class="token operator">&lt;</span>---- start 配置开机自启动
// 在 /usr/lib/systemd/system 目录下创建 nacos.service ，并添加以下内容

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>nacos
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/setup/nacos/bin/startup.sh <span class="token parameter variable">-m</span> standalone
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/usr/setup/nacos/bin/shutdown.sh
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/setup/nacos/bin/shutdown.sh
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

// 开启自启动服务
<span class="token comment"># systemctl enable nacos.service</span>

// 重新加载自启动服务
<span class="token comment"># systemctl daemon-reload</span>
// 配置开机自启动 end ----<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,37),cs={href:"http://192.168.1.150:8848/nacos",target:"_blank",rel:"noopener noreferrer"},os=t(`<h4 id="_4-2-创建provider模块" tabindex="-1"><a class="header-anchor" href="#_4-2-创建provider模块" aria-hidden="true">#</a> 4.2. 创建provider模块</h4><p>使用springinital工具进行创建项目模块。</p><ol><li>修改pom</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 修改SpringBoot的版本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加dependencyManagement版本管理 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--springcloud--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!--springcloud alibaba--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${spring-cloud-alibaba-version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加web依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加nacos依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建配置文件application.yml</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10000</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 注册到nacos上的服务名称，也是服务发现的名称，必写</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos的注册地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment"># yml文件中存在特殊字符，必须用单引号包含，否则启动报错</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&#39;*&#39;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>开启服务注册与发现</li></ol><figure><img src="`+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>编写测试类</li></ol><figure><img src="'+v+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>浏览器中输入： <code>http://localhost:10000/provider/hello</code> ，访问成功。</p><h4 id="_4-3-创建consumer模块" tabindex="-1"><a class="header-anchor" href="#_4-3-创建consumer模块" aria-hidden="true">#</a> 4.3. 创建consumer模块</h4><ol><li>修改pom</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 修改SpringBoot的版本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加dependencyManagement版本管理 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--springcloud--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!--springcloud alibaba--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${spring-cloud-alibaba-version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加web依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 添加nacos依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建配置文件</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10000</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 注册到nacos上的服务名称，也是服务发现的名称，必写</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos的注册地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment"># yml文件中存在特殊字符，必须用单引号包含，否则启动报错</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&#39;*&#39;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>开启服务注册与发现</li></ol><figure><img src="`+m+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>编写测试类</li></ol><figure><img src="'+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>浏览器中输入： <code>http://localhost:11000/consumer/hello</code> ，访问成功。</p><h4 id="_4-4-实现远程调用" tabindex="-1"><a class="header-anchor" href="#_4-4-实现远程调用" aria-hidden="true">#</a> 4.4. 实现远程调用</h4><p>我们这里采用两种不同的客户端来完成远程调用。</p><ol><li>使用RestTemplate访问provider接口</li></ol><ul><li>添加配置项</li></ul><figure><img src="'+g+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>添加配置文件</li></ul><figure><img src="'+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>添加调用过程</li></ul><figure><img src="'+f+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>浏览器中输入： <code>http://localhost:11000/consumer/hello1</code> ，访问成功。</p><ol start="2"><li>使用OpenFeign访问provider接口</li></ol><ul><li>修改pom</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- pom中添加openfeign依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>开启openfeign客户端</li></ul><figure><img src="`+y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>编写service</li></ul><figure><img src="'+_+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>执行调用过程</li></ul><figure><img src="'+x+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>浏览器中输入： <code>http://localhost:11000/consumer/hello2</code> ，访问成功。</p><h3 id="_5-nacos开发实践" tabindex="-1"><a class="header-anchor" href="#_5-nacos开发实践" aria-hidden="true">#</a> 5. Nacos开发实践</h3><p>当项目在实际开发过程中会有很多的环境，如dev、sit、uat、prd等环境。在不同的环境中，可以通过配置多套nacos服务，并在不同的配置文件中配置上相应的nacos服务地址，实现环境隔离。</p><p>但是在同一套环境下进行代码联调时，就会出现问题。比如在开发过程中，A和C两位开发需要联调，A成员启动了provider项目并注册到dev环境的nacos中，B成员也启动了provider项目并注册到dev环境的nacos中，那么如果C成员启动了consumer项目注册到dev环境的nacos中调用provider时，就会出现C成员的请求，可能会转发到B成员的provider项目中。</p><p>可以使用nacos中的命名空间和命名分组的方式进行界定。</p><ol><li>在nacos中创建dev的命名空间</li></ol><figure><img src="'+w+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>在A代码中添加命名空间和命名分组的配置</li></ol><figure><img src="'+S+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="3"><li>在B代码中也添加命名空间和命名分组的配置</li></ol><figure><img src="'+E+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>验证</li></ol><p>浏览器中分别输入： <code>http://localhost:11000/consumer/hello1</code> 、 <code>http://localhost:11000/consumer/hello2</code> ，均访问成功。</p><h3 id="_6-特别说明" tabindex="-1"><a class="header-anchor" href="#_6-特别说明" aria-hidden="true">#</a> 6. 特别说明</h3><p>读者在实践过程中要特别组件之间版本的选择，最好跟笔者的版本保持一致，不然会出现意想不到的问题，读者可以像笔者一样自定义一个starter统一管理组件的版本。</p><h3 id="_7-总结" tabindex="-1"><a class="header-anchor" href="#_7-总结" aria-hidden="true">#</a> 7. 总结</h3><ol><li>介绍了分布式服务治理技术的产生背景及相关内容；</li><li>介绍了分布式服务治理的相关技术选型；</li><li>Nacos的服务注册与发现的两种RPC调用过程及开发过程中的最佳实践；</li></ol><h2 id="_9-nacos服务配置" tabindex="-1"><a class="header-anchor" href="#_9-nacos服务配置" aria-hidden="true">#</a> 9. nacos服务配置</h2><ol><li>分布式服务配置的背景知识；</li><li>技术选型；</li><li>Nacos 相关概念</li><li>实战 <ol><li>SpringBoot 获取本地配置的使用方式；</li><li>接入 Nacos 后获取分布式配置的使用方式； <ol><li>基本使用方式；</li><li>共享配置文件获取配置的使用方式；</li><li>映射成 JavaBean 的使用方式；</li><li>实时更新；</li></ol></li></ol></li><li>Nacos 的最佳实践</li><li>高可用</li></ol><h3 id="_1-背景知识" tabindex="-1"><a class="header-anchor" href="#_1-背景知识" aria-hidden="true">#</a> 1. 背景知识</h3><p>在实际的项目中，一般都会使用到一些配置文件，如配置数据库链接、配置log级别和输出方式……，在传统的单体应用中，我们一般会把配置项与项目部署文件放到一起，配置项会随着代码的修改进行部署生效。这样也无可厚非。</p><p>但是随着技术的发展，在微服务架构中，由于微服务架构具有以下特点：</p><ol><li>具有多个不同的环境，如DEV、SIT、UAT、PRD等；</li><li>迭代周期短；</li><li>配置项多而杂；</li><li>……</li></ol><p>总之，就是配置过程频繁而繁琐。此时如果还用传统单体应用管理配置项的方式来管理配置，就显得有些格格不入了。于是我们需要一种新型的管理配置的方式。此时，配置中心应运而生。</p><h3 id="_2-技术选型" tabindex="-1"><a class="header-anchor" href="#_2-技术选型" aria-hidden="true">#</a> 2. 技术选型</h3><p>早期，配置中心的主要功能特性是管理配置，但随着技术的发展和业务的需求，加上程序员极致热情，配置中心有多了一些权限管理、实时更新、版本管理、灰度管理、安全配置等一系列的高级特性。</p>',66),us={href:"https://mp.weixin.qq.com/s/AUHY3nKZqDbAhkfebOPWCg",target:"_blank",rel:"noopener noreferrer"},ds=n("h3",{id:"_3-nacos相关概念",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-nacos相关概念","aria-hidden":"true"},"#"),s(" 3. Nacos相关概念")],-1),rs=n("blockquote",null,[n("p",null,"微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。")],-1),ks=n("p",null,"关于nacos服务的搭建过程，请参考笔者系列文章的《分布式服务治理之Nacos》章节，这里不再赘述。Nacos有几个重要的概念：",-1),vs=n("code",null,"${prefix}-${spring.profiles.active}.${file-extension}",-1),ms={href:"http://spring.application.name",target:"_blank",rel:"noopener noreferrer"},bs=n("code",null,"${prefix}-${spring.profiles.active}.${file-extension}",-1),gs=n("code",null,"properties",-1),hs=n("code",null,"yaml",-1),fs=n("li",null,[s("命名空间 "),n("ul",null,[n("li",null,"NameSpace ： 命名空间，是一种隔离手段，用来隔离不同环境或不同分组的profile；"),n("li",null,"Group： 命名分组，也是一种隔离手段，可以在命名空间级别上再次进行隔离；"),n("li",null,"区别： 命名空间的隔离粒度较粗，命名分组的隔离粒度较细；")])],-1),ys=n("p",null,"下面我们通过不同的业务场景，来看一下不同方式获取配置项的区别。",-1),_s=n("h3",{id:"_4-实战",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-实战","aria-hidden":"true"},"#"),s(" 4. 实战")],-1),xs=n("h4",{id:"_4-1-springboot-传统方式获取本地配置项",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-1-springboot-传统方式获取本地配置项","aria-hidden":"true"},"#"),s(" 4.1. SpringBoot 传统方式获取本地配置项")],-1),ws={href:"/Value",target:"_blank",rel:"noopener noreferrer"},Ss=n("ol",null,[n("li",null,"在配置文件中填写配置内容；")],-1),Es=n("figure",null,[n("img",{src:C,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),Cs={start:"2"},Ts={href:"/Value",target:"_blank",rel:"noopener noreferrer"},Ns=t('<figure><img src="'+T+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+N+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这种方式有一个缺点：<code>每次修改配置项，都需要重启应用；无法满足在项目中实时感知配置项的变化的需求。</code></p><h4 id="_4-2-接入-nacos-后获取分布式配置的使用方式" tabindex="-1"><a class="header-anchor" href="#_4-2-接入-nacos-后获取分布式配置的使用方式" aria-hidden="true">#</a> 4.2. 接入 Nacos 后获取分布式配置的使用方式</h4><h5 id="_4-2-1-应用接入nacos" tabindex="-1"><a class="header-anchor" href="#_4-2-1-应用接入nacos" aria-hidden="true">#</a> 4.2.1. 应用接入nacos</h5><p>应用程序接入第三方组件的过程大概都可以分成以下几个步骤：</p><ol><li>pom文件中引入组件的相关依赖坐标；</li><li>在配置文件中添加配置项，即配置的key-value键值对，或者使用@Component、@Configuration+JavaBean的方式进行配置；</li><li>有些组件还需要在启动类上添加相关的注解来开启功能；</li><li>进行使用</li></ol><p>Nacos的接入也分成三个步骤：</p><ol><li>pom中引入相关依赖</li></ol><p>由于引入了自制的项目的starter工程来统一管理依赖的版本，因此在这个模块中只需要添加 groupId和artifactId即可，不需要添加版本。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>配置nacos相关信息</li></ol><p>Nacos作为注册中心，完全替代了原有的配置文件，因此需要使用更高级别的配置文件，即 bootstrap 的配置文件，因此nacos的配置内容需要在 bootstrap.yml 文件中完成。</p><figure><img src="`+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="3"><li>直接使用</li></ol><p>参见下面使用样例。</p><h5 id="_4-2-2-直接使用nacos获取配置项" tabindex="-1"><a class="header-anchor" href="#_4-2-2-直接使用nacos获取配置项" aria-hidden="true">#</a> 4.2.2. 直接使用nacos获取配置项</h5><ol><li>在nacos的控制台添加配置项</li></ol><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>通过@Value标注变量，并获取配置项</li></ol><figure><img src="'+R+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+L+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_4-2-3-使用nacos共享配置文件方式获取配置项" tabindex="-1"><a class="header-anchor" href="#_4-2-3-使用nacos共享配置文件方式获取配置项" aria-hidden="true">#</a> 4.2.3. 使用nacos共享配置文件方式获取配置项</h5><p>在实际开发过程中，一个项目可能会有多个配置项，如需要配置redis、mysql、mq等，那么我们就可以使用nacos的共享配置文件的方式获取配置项。</p><ol><li>在bootstrap.yml中添加共享配置项的配置</li></ol><figure><img src="'+I+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>在nacos控制台添加共享配置项</li></ol><figure><img src="'+O+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="3"><li>通过@Value标注变量，并获取配置项</li></ol><figure><img src="'+M+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_4-2-4-共享配置文件映射成javabean" tabindex="-1"><a class="header-anchor" href="#_4-2-4-共享配置文件映射成javabean" aria-hidden="true">#</a> 4.2.4. 共享配置文件映射成JavaBean</h5><p>上面的样例中，我们都是先通过@Value标注变量，但是这种方式还有不够便捷，既然是面向对象编程，那么我们就希望获取到的配置文件转成JavaBean的方式进行使用。请看下面样例：</p><ol><li>在bootstrap.yml中添加共享配置项的配置</li></ol><figure><img src="'+U+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>控制台添加配置</li></ol><figure><img src="'+D+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="3"><li>添加配置项的JavaBean进行映射</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;mybrother&quot;</span><span class="token punctuation">)</span><span class="token comment">// prefix 的值就是控制台添加的配置文件的名称</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBrotherInfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token class-name">String</span> sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>注入JavaBean后进行使用</li></ol><figure><img src="`+z+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+j+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们还可以把不同项目的一些公共配置放到一个配置文件中，然后在不同的项目中设置相同的配置项，达到<code>一处变更，处处修改</code>的目的。</p><h5 id="_4-2-5-实时获取配置变更" tabindex="-1"><a class="header-anchor" href="#_4-2-5-实时获取配置变更" aria-hidden="true">#</a> 4.2.5. 实时获取配置变更</h5>',43),As={href:"/RefreshScope",target:"_blank",rel:"noopener noreferrer"},qs=t(`<h3 id="_5-nacos方式-vs-传统方式" tabindex="-1"><a class="header-anchor" href="#_5-nacos方式-vs-传统方式" aria-hidden="true">#</a> 5. Nacos方式 vs 传统方式</h3><p>传统方式：</p><ol><li>每次配置变更都需要重启服务；</li><li>无法实时感知配置项的变化过程；</li><li>集群架构下，无法实现“一处修改，处处修改”的效果；</li></ol><p>使用nacos作为配置中心：</p><ol><li>配置变更后不需要重启服务；</li><li>可以实时感知到配置的变化过程；</li><li>能实现集群架构下，“一处修改，处处修改”的效果；</li></ol><h3 id="_6-开发的最佳实践" tabindex="-1"><a class="header-anchor" href="#_6-开发的最佳实践" aria-hidden="true">#</a> 6. 开发的最佳实践</h3><blockquote><p>微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。</p></blockquote><p>通过上面的案例，我们可以了解到Nacos作为配置中心有几个重要的功能特性：</p><ol><li>命名空间</li><li>命名分组</li><li>共享文件配置</li></ol><p>实际的开发过程肯定要比上面的几种简单案例复杂，那么我们在实际的开发过程中如何使用这几种配置方式呢？</p><h4 id="_6-1-方式一" tabindex="-1"><a class="header-anchor" href="#_6-1-方式一" aria-hidden="true">#</a> 6.1. 方式一</h4><p>为每一个服务都创建一个namespace，然后不同的环境使用不同的Group来隔离。如不同模块的开发环境的配置文件统一放到DEV的命名空间下，在同一个命名空间下，我们可以通过不同的命名分组进行区分，如模块A的开发环境的配置文件属于DEV命名空间下的GroupA，模块B的开发环境的配置文件属于DEV命名空间下的GroupB。</p><p>这样做的好处是符合传统的以不同环境作为区分的思路，便于理解；并且还可以让不同的应用在相同环境下共享配置文件；但是这种方式也有坏处，那就是不能跨环境共享配置文件。</p><h4 id="_6-2-方式二" tabindex="-1"><a class="header-anchor" href="#_6-2-方式二" aria-hidden="true">#</a> 6.2. 方式二</h4><p>为每一个环境都配置一个namespace，不同的服务使用同名的配置文件；实际操作上，我们可以使用服务名作为命名空间，再通过命名分组进行区分不同的环境。这种方式是把不同环境的配置文件放到了同一个命名空间下，实现了不同环境下的共享配置文件的配置。但这种方式也有缺点，那就是可能每一个服务的命名空间中都有相同的一份配置文件，也就是不同服务无法共享一些公共的配置文件。</p><h3 id="_7-nacos的高可用" tabindex="-1"><a class="header-anchor" href="#_7-nacos的高可用" aria-hidden="true">#</a> 7. Nacos的高可用</h3><p>相比较传统单体应用中，配置文件跟业务代码放到一起的方式，配置中心的方式相当于集中管理配置，在使配置便捷化的过程中，也引入了一个重要的问题，那就是：配置中心异常无法对外提供服务后，会导致所有的应用无法获取配置，导致项目启动不起来。</p><p>针对这个问题Nacos也提供了解决方案，那就是Nacos的高可用机制。简单来说就是部署多个Nacos实例，让Nacos形成集群，统一对外提供服务。 Nacos的集群模式这里不再赘述，详见官方文档。</p><p>此外Nacos本身是由Java语言编写，Nacos也支持持久化，有兴趣的读者可以自行研究一下持久化的部署过程。</p><h3 id="_8-总结" tabindex="-1"><a class="header-anchor" href="#_8-总结" aria-hidden="true">#</a> 8. 总结</h3><ol><li>介绍了配置中心出现的背景；</li><li>分别介绍了传统方式获取配置项及Nacos获取配置项的不同方式，并简单介绍了这几种方式的区别；</li><li>介绍了Nacos在实际开发场景下的不同实践方式以及它们的优缺点；</li><li>简单介绍了Nacos的其他高级特性；</li></ol><h2 id="_10-openfeign远程调用" tabindex="-1"><a class="header-anchor" href="#_10-openfeign远程调用" aria-hidden="true">#</a> 10. openfeign远程调用</h2><h3 id="_1-背景知识-1" tabindex="-1"><a class="header-anchor" href="#_1-背景知识-1" aria-hidden="true">#</a> 1. 背景知识</h3><p>在单体应用，不同功能模块之间的调用过程多是通过调用方法来实现的，而拆分成微服务架构后，由于物理部署方式的改变（主要表现形式是：单个部署包变成多个部署包），不同模块之间的调用方式也发生了本质上的改变。</p><p>微服务架构中，服务之间的调用大多是通过RPC调用完成的，RPC就是远程服务调用。通俗点讲就是被调用者通过暴露接口，调用者调用被调用者暴露出来的接口来实现调用过程。</p><p>简单说一下RPC和SOA的区别，SOA的主要特点是构建一种消息组件，让所有的服务统一通过这个消息组件实现相互调用，它主要的特点是有一个统一的消息组件，另外一个特点是所有的服务提供的接口都是经过统一格式定义过的，Dubbo和WebService都属于SOA的范畴。而RPC则是取消了统一的消息组件，服务与服务之间的调用是通过直接的网络调用，调用过程优雅，像本地调用一样简单便捷，SpringCloud技术栈属于这个范畴。</p><p>在微服务的发展的早期，远程服务调用多是通过JDK原生的URLConnection来实现的，后期出现了HttpClient、OkHttp的组件。目前微服务架构中，多是使用RestTemplat和OpenFeign来完成远程服务调用的。</p><h3 id="_2-技术选型-1" tabindex="-1"><a class="header-anchor" href="#_2-技术选型-1" aria-hidden="true">#</a> 2. 技术选型</h3><p>OpenFeign是SpringCloud官方提供的远程服务调用的组件，我们“别无选择”，就它了。需要注意的是，SpringCloud还提供了RestTemplate组件，也可以完成远程服务调用。关于RestTemplate方式调用和OpenFeign方式的简单调用，也可以参考笔者的系列文章的《服务治理之Nacos》章节进行查阅。</p><h3 id="_3-实战" tabindex="-1"><a class="header-anchor" href="#_3-实战" aria-hidden="true">#</a> 3. 实战</h3><p>要想使用OpenFeign，我们就要先明白它的大概原理： 服务生产者与服务消费者都注册到服务治理中心上，服务调用者在调用过程中，先从服务治理中心获取服务生产者的地址，然后再组装实际的调用地址，之后完成服务的调用。因此我们还需要一个服务治理中心，这里我们还是使用Nacos。</p><p>下面带大家一起搭建一下所需要的测试框架。</p><h4 id="_3-1-基本使用" tabindex="-1"><a class="header-anchor" href="#_3-1-基本使用" aria-hidden="true">#</a> 3.1. 基本使用</h4><h5 id="_3-1-1-服务生产者-nacos-provider" tabindex="-1"><a class="header-anchor" href="#_3-1-1-服务生产者-nacos-provider" aria-hidden="true">#</a> 3.1.1. 服务生产者（nacos-provider）</h5><ul><li>引入服务发现的依赖</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>注册中心相关配置</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 注册到nacos上的服务名称，也是服务发现的名称，必写</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos的注册地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token comment"># gateway</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> deeaeca6<span class="token punctuation">-</span>bed9<span class="token punctuation">-</span>4fb1<span class="token punctuation">-</span>b5b7<span class="token punctuation">-</span>9c79278561ca

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>开启服务注册与发现</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>  <span class="token comment">// 开启服务的注册与发现</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosProviderApplication</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosProviderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>对外暴露接口进行测试启动</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;provider&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello, provider!!!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动后，查看nacos控制台，服务已经注册到nacos上面，postman请求 hello 接口，请求成功。</p><h5 id="_3-1-2-服务消费者-nacos-consumer" tabindex="-1"><a class="header-anchor" href="#_3-1-2-服务消费者-nacos-consumer" aria-hidden="true">#</a> 3.1.2. 服务消费者（nacos-consumer）</h5><p>服务消费者框架的搭建过程与服务生产者的搭建过程一样，不再赘述。不同的是服务消费者要使用OpenFeign，因此还需要下面几个步骤。</p><ul><li>引入OpenFeign的依赖</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建OpenFeign的Service</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;nacos-provider&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProviderService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/provider/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>开启服务注册与发现并添加客户端的扫描包路径</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span><span class="token string">&quot;com.tianqingxiaozhu.nacos.consumer.service&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 扫描包路径</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">// 开启服务的注册与发现</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConsumerApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费接口</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 注入OpenFeign的接口
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProviderService</span> providerService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 消费接口
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> providerService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动测试</li></ul><p>查看nacos控制台，发现服务已经注册到nacos上，请求接口也成功。</p><blockquote><p>OpenFeign的基本用法是：</p><ol><li>服务生产者对外暴露接口；</li><li>服务消费者创建service链接接口；</li><li>控制层注入service后进行消费；</li></ol></blockquote><h4 id="_3-2-openfeign高级特性" tabindex="-1"><a class="header-anchor" href="#_3-2-openfeign高级特性" aria-hidden="true">#</a> 3.2. OpenFeign高级特性</h4><blockquote><p>微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。</p></blockquote><p>在实际的项目开发过程中，我们大多情况下使用的是POST请求，但是会有多种不同的情况，下面我们分别介绍一下POST协议下不同的请求方式。但是服务生产者会提供多种接口，例如：包含多个参数、路径中携带参数、需要传递对象、文件上传、下载等，下面我们实践一下。</p><h5 id="_3-2-1-开启日志" tabindex="-1"><a class="header-anchor" href="#_3-2-1-开启日志" aria-hidden="true">#</a> 3.2.1. 开启日志</h5><p>在开发过程中，有时我们需要开启远程调用的日志信息，以便我们进行排错，开启只需要在消费者中配置：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.tianqingxiaozhu.nacos.consumer.service</span><span class="token punctuation">:</span> debug

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>com.tianqingxiaozhu.nacos.consumer.service</code> 是消费者接口所在的包路径。</p><h5 id="_3-2-2-多参数" tabindex="-1"><a class="header-anchor" href="#_3-2-2-多参数" aria-hidden="true">#</a> 3.2.2. 多参数</h5><ul><li>服务生产者对外提供 test01 接口，此接口有两个参数： <code>name</code> 和 <code>age</code> ，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test01&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;name: &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; age: &quot;</span> <span class="token operator">+</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,66),Rs={href:"/RequestParam",target:"_blank",rel:"noopener noreferrer"},Ls=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/provider/test01&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试结果，</li></ul><figure><img src="`+B+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_3-2-3-url中携带参数" tabindex="-1"><a class="header-anchor" href="#_3-2-3-url中携带参数" aria-hidden="true">#</a> 3.2.3. URL中携带参数</h5><ul><li>服务生产者对外提供 test02 接口，此接口需要在路径中携带参数 <code>name</code> 和 <code>age</code> ，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * URL中携带参数
 * <span class="token keyword">@param</span> <span class="token parameter">name</span>
 * <span class="token keyword">@param</span> <span class="token parameter">age</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test02/{name}/{age}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test02</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;name: &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;, age: &quot;</span> <span class="token operator">+</span> age<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),Is={href:"/PathVariable",target:"_blank",rel:"noopener noreferrer"},Os=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/provider/test02/{name}/{age}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token function">test02</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试结果，</li></ul><figure><img src="`+F+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_3-2-4-传递对象" tabindex="-1"><a class="header-anchor" href="#_3-2-4-传递对象" aria-hidden="true">#</a> 3.2.4. 传递对象</h5><ul><li>服务生产者提供的接口需要使用Student对象进行访问，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test03&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test03</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Student</span> student<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>服务消费者servicd需要使用@RequestBody注解进行标注生产者接口的参数类型，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/provider/test03&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">test03</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Student</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费者controller创建一个对象传递给消费者，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test03&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test03</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    student<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;laowang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    student<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    providerService<span class="token punctuation">.</span><span class="token function">test03</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试结果，</li></ul><figure><img src="`+P+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_3-2-5-文件上传" tabindex="-1"><a class="header-anchor" href="#_3-2-5-文件上传" aria-hidden="true">#</a> 3.2.5. 文件上传</h5><ul><li>生产者接收到文件后，返回文件的名称，</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/test04&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test04</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15),Ms={href:"/RequestPart",target:"_blank",rel:"noopener noreferrer"},Us={href:"/PostMapping",target:"_blank",rel:"noopener noreferrer"},Ds=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/provider/test04&quot;</span><span class="token punctuation">,</span>
            produces <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token function">test04</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费者controller上传文件后转发给生产者接口</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/test04&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test04</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> providerService<span class="token punctuation">.</span><span class="token function">test04</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试</li></ul><figure><img src="`+G+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_3-2-6-文件下载" tabindex="-1"><a class="header-anchor" href="#_3-2-6-文件下载" aria-hidden="true">#</a> 3.2.6. 文件下载</h5><p>文件下载有多种实现方式，比如</p><ol><li>客户端传入文件路径，服务端根据文件路径，读取文件内容转成输入流，把输入流返回给客户端，客户端再把流写入文件后保存到本地；</li><li>使用oss对象存储</li></ol><p>下面使用第一种方式进行实践，</p><ul><li>生产者根据传入文件的的路径以及文件名读取文件流，并转成输出流返回给客户端</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * 文件下载
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@param</span> <span class="token parameter">myFiles</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/test05&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test05</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MyFiles</span> myFiles<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> filepath <span class="token operator">=</span> myFiles<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>myFiles<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/x-download;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">Charsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Disposition&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;attachment;filename=&quot;</span> <span class="token operator">+</span> myFiles<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputStream</span>    out             <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span>            buffer<span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ServletOutputStream</span> outputStream <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;下载失败....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11),zs={href:"/RequestBody",target:"_blank",rel:"noopener noreferrer"},js=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/provider/test05&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span>
<span class="token class-name">Response</span> <span class="token function">test05</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MyFiles</span> myFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>消费者controller</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * 下载
 * <span class="token keyword">@param</span> <span class="token parameter">myFiles</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test05&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test05</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MyFiles</span> myFiles<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> myFiles<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> myFiles<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpServletResponse
            <span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/x-download;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">Charsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpServletResponse<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Disposition&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;attachment;filename=&quot;</span> <span class="token operator">+</span> myFiles<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Response</span> response <span class="token operator">=</span> providerService<span class="token punctuation">.</span><span class="token function">test05</span><span class="token punctuation">(</span>myFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Response<span class="token punctuation">.</span>Body</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> httpServletResponse<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">asInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;下载文件异常 filepath:[{}]&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试结果</li></ul><figure><img src="`+H+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_3-2-7-开启gzip压缩" tabindex="-1"><a class="header-anchor" href="#_3-2-7-开启gzip压缩" aria-hidden="true">#</a> 3.2.7. 开启GZIP压缩</h5><p>有时为了节省网络带宽，我们需要对OpenFeign进行请求的压缩，其原理大概是，对请求的数据提供一种压缩算法，使用这种算法对数据进行压缩，接收到数据再使用同样的算法对数据进行解压。</p><p>开启GZIP压缩也很简单，只需要在服务消费端配置上：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">compression</span><span class="token punctuation">:</span>
    <span class="token key atrule">request</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">mime-types</span><span class="token punctuation">:</span> text/xml<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>application/json <span class="token comment"># 压缩的请求类型</span>
      <span class="token key atrule">min-request-size</span><span class="token punctuation">:</span> <span class="token number">2048</span> <span class="token comment"># 压缩数据的下限</span>
    <span class="token key atrule">response</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启响应的zip压缩</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-8-超时控制" tabindex="-1"><a class="header-anchor" href="#_3-2-8-超时控制" aria-hidden="true">#</a> 3.2.8. 超时控制</h5><p>有时候由于网络问题，生产者提供的接口的响应时间过长，就会造成消费者接口的请求时间过长，继而响应异常，此时我们就需要修改客户端的默认链接时间：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 修改客户端的连接超时时间</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实验时，我们可以在生产者提供的接口中休眠3s，就会发现消费者接口报错。然后我们通过配置消费者的客户端链接超时时间，重新启动后就会发现响应正常。</p><h5 id="_3-2-9-替换默认的客户端" tabindex="-1"><a class="header-anchor" href="#_3-2-9-替换默认的客户端" aria-hidden="true">#</a> 3.2.9. 替换默认的客户端</h5><p>OpenFeign底层用的是JDK原生的URLConnection作为客户端的，但是我们可以自定义客户端，如可以配置Apache的HttpClient或者Okhttp。</p><p>替换默认的客户端的方法很简单，主要有两步，下面以替换成Okhttp为例：</p><ul><li>添加要替换的客户端的依赖坐标</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--okhttp客户端--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在配置文件中开启</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">okhttp</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 启用okhttp</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-10-其他" tabindex="-1"><a class="header-anchor" href="#_3-2-10-其他" aria-hidden="true">#</a> 3.2.10. 其他</h5><p>此外OpenFeign还有其他高级特性，有兴趣的读者可以自行实践一下：</p><ol><li>自定义配置某一个Feign客户端的相关属性；</li><li>Feign调用时透传特定请求头</li><li>...</li></ol><h3 id="_4-openfeign的原理" tabindex="-1"><a class="header-anchor" href="#_4-openfeign的原理" aria-hidden="true">#</a> 4. OpenFeign的原理</h3>`,24),Bs={href:"/EnableFeignClients",target:"_blank",rel:"noopener noreferrer"},Fs=n("li",null,"当发生调用时，Spring会通过JDK代理的方式，为客户端生成具体的RestTemplate；",-1),Ps=n("li",null,"在把RestTemplate 生成的Request交给具体的Client，最后Client被封装到 LoadBalanceClient 类，这个类会结合 Ribbon 负载均衡发起服务的调用；",-1),Gs=t('<h3 id="_5-总结" tabindex="-1"><a class="header-anchor" href="#_5-总结" aria-hidden="true">#</a> 5. 总结</h3><ol><li>介绍了SpringCloud的远程调用组件及在调用过程中的两个服务角色： 生产者 和 消费者；</li><li>实践了OpenFeign的几种高级特性；</li><li>介绍了OpenFeign的工作原理；</li></ol><h2 id="_11-gateway分布式网关" tabindex="-1"><a class="header-anchor" href="#_11-gateway分布式网关" aria-hidden="true">#</a> 11. gateway分布式网关</h2><h3 id="_1-背景知识-2" tabindex="-1"><a class="header-anchor" href="#_1-背景知识-2" aria-hidden="true">#</a> 1. 背景知识</h3><p>我们知道，假如一个组织内，有3个微服务，并且微服务与微服务之间可以相互调用，那么调用关系就有8种，此时我们需要在每一个微服务中配置好另外其他所有的微服务的信息，假设其中某一个服务的信息需要修改呢？再假设每一个服务都需要对其他服务调用接口时进行身份认证和权限校验呢？事实上，人们正是因为在实际的开发过程中遇到了上述的那些问题，所以才开发出了网关组件。</p><h3 id="_2-网关的必要性" tabindex="-1"><a class="header-anchor" href="#_2-网关的必要性" aria-hidden="true">#</a> 2. 网关的必要性</h3><figure><img src="'+Y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>上面是一个互联网应用典型的部署视图，从上面我们可以看到，一般情况下，我们会把应用部署划分成几个网络区域：</p><ul><li><code>互联网</code>： 所有用户和应用都可以访问的网络区域</li><li><code>外联网关</code>： 是同属于一个企业内所有组织的所有应用的出口。</li><li><code>内联网关</code>： 是同属于一个组织内的所有应用对外的出口。</li><li><code>HOST ZONE</code>： 应用服务区域，也就是我们常说的后端服务所部署的区域。在组织架构中，它属于单个组织架构，在应用中，它属于同一个应用。</li></ul><p>需要注意的是，外联网关、內联网关和HOST ZONE区域，是层层嵌套的，内联网关包含HOST ZONE，外联网关又包含内联网关。例如，在一个企业内有成百上千的微服务应用，每个业务团队负责不同的微服务应用，那么内联网关的作用就是用来隔<code>离每个业务团队的不同微服务之间的网络通信</code>；而外联网关的作用就是把<code>企业内的所有业务团队所负责的微服务</code>与<code>企业外部的用户或者业务相关的其他企业的应用</code>进行隔离.</p><p>微服务架构中，网关服务是独立存在的，它也称为逻辑网关，与SLB/Nginx/OpenResty的物理网关在部署形式上是不同的，网关服务的存在形式是一个独立的微服务，一般是需要进行代码的定制化开发的，而SLB/Nginx/OpenResty的物理网关的存在形式可能是n台独立的服务器（一般情况下是具有高性能的网络通信能力的服务器），也有可能是具有高性能网关硬件的虚拟服务器。</p><p>内联网关除了具备最基本的网络隔离功能外，一般还具备：</p><ol><li>身份认证、鉴权：为下游服务发送来的请求提供身份认证及相关鉴权功能。</li><li>限流、熔断、降级、流量监控：保护上游提供响应的服务及监控上游各个微服务的健康状况。</li><li>协议转换：由于上游各个微服务所使用的通信协议有可能不同，因此网关还承担着协议转换的功能。</li><li>......</li></ol><h3 id="_3-技术选型" tabindex="-1"><a class="header-anchor" href="#_3-技术选型" aria-hidden="true">#</a> 3. 技术选型</h3>',14),Hs={href:"https://mp.weixin.qq.com/s/AUHY3nKZqDbAhkfebOPWCg",target:"_blank",rel:"noopener noreferrer"},Ys=t(`<h3 id="_4-spring-cloud-gateway" tabindex="-1"><a class="header-anchor" href="#_4-spring-cloud-gateway" aria-hidden="true">#</a> 4. Spring Cloud Gateway</h3><h4 id="_4-1-版本关系" tabindex="-1"><a class="header-anchor" href="#_4-1-版本关系" aria-hidden="true">#</a> 4.1. 版本关系</h4><p>由于我们已经规定了SpringCloud及SpringCloud-Alibaba的版本，因此我们直接在pom文件中引入Gateway的坐标，不需要带版本号，SpringCloud及SpringCloud-Alibaba会自动帮我们选择版本号。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-相关概念" tabindex="-1"><a class="header-anchor" href="#_4-2-相关概念" aria-hidden="true">#</a> 4.2. 相关概念</h4><ul><li>路由： 是由ID、目标URI、断言集合和过滤器集合构成，表示如果实际请求的路由满足断言集合的条件，就执行过滤器集合规定的相关动作；</li><li>断言： 就是对应的路由判断条件；</li><li>过滤器： 满足断言后执行的动作；</li></ul><p>需要注意的是：断言和过滤器都是一个集合，由二者组成的路由也是一个集合。</p><h3 id="_5-框架搭建" tabindex="-1"><a class="header-anchor" href="#_5-框架搭建" aria-hidden="true">#</a> 5. 框架搭建</h3><blockquote><p>微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。</p></blockquote><p>搭建网关工程很简单，使用spring initial 工具生成工程代码后，引入gateway依赖，再添加配置文件和启动类即可，引入的依赖如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-实战" tabindex="-1"><a class="header-anchor" href="#_6-实战" aria-hidden="true">#</a> 6. 实战</h3><p>下面根据不同的使用场景来分别进行实践操作。</p><h4 id="_6-1-请求转发" tabindex="-1"><a class="header-anchor" href="#_6-1-请求转发" aria-hidden="true">#</a> 6.1. 请求转发</h4><p>假如有一个业务场景，要求所有带了 &quot;green&quot; 参数的路由都转发到百度网站。实践过程如下：</p><ul><li>配置文件中添加路由</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> query_router <span class="token comment"># 路由规则的名称，可以自定义</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 断言</span>
            <span class="token punctuation">-</span> Query=green <span class="token comment"># 参数</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//baidu.com <span class="token comment"># 执行跳转的URI</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试</li></ul>`,18),Ks={href:"http://localhost:15000?green",target:"_blank",rel:"noopener noreferrer"},Vs=t('<figure><img src="'+K+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_6-2-重写路由" tabindex="-1"><a class="header-anchor" href="#_6-2-重写路由" aria-hidden="true">#</a> 6.2. 重写路由</h4><p>假设有一个业务场景，要求所有 <code>/test</code> 下的请求，都转发到provider服务的对应请求，如网关的 <code>/test/hello</code>就需要转发到<code>provider</code>服务的 <code>/providerbygateway/hello</code>。由于需要转发给对应的provider微服务，因此还需要把网关服务注册到注册中心，同样的provider服务也需要注册到注册中心，实践过程如下：</p><ul><li>网关服务添加nacos注册中心的依赖</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>配置文件中配置nacos注册中心的地址</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>demo
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> deeaeca6<span class="token punctuation">-</span>bed9<span class="token punctuation">-</span>4fb1<span class="token punctuation">-</span>b5b7<span class="token punctuation">-</span>9c79278561ca

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动类上添加注册发现的开关注解</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>  <span class="token comment">// 添加服务注册与发现的注解</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayDemoApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在网关的配置文件添加路由规则</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token comment"># provider</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> provider_router
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/test/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> RewritePath=/test/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span>/providerbygateway/$\\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> 
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//nacos<span class="token punctuation">-</span>provider

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据官方文档， filters 的配置项中重写路径 RewritePath 的的值有两部分，第一部分 /test/ 后面的 <code>(?&lt;segment&gt;.*)</code>  表示任意一段请求路径，第二部分后面的 <code>$\\{segment}</code> 表示与第一部分一样的一段请求路径。 uri 配置项中的 lb 表示转发到的服务使用负载均衡。</p><ul><li>在nacos-provider中添加转发的目的接口</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;providerbygateway&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello, provider!!!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动两个服务，进行测试</li></ul><figure><img src="`+V+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_6-3-其他基础功能" tabindex="-1"><a class="header-anchor" href="#_6-3-其他基础功能" aria-hidden="true">#</a> 6.3. 其他基础功能</h4><p>由上面两个实战示例可以看出，网关的开发很简单，只需要在配置文件中配置上路由、断言和过滤器即可，几乎不需要有其他额外的代码。</p>',18),Js={href:"https://docs.spring.io/spring-cloud-gateway/docs/2.2.x/reference/html/#gateway-request-predicates-factories",target:"_blank",rel:"noopener noreferrer"},Zs=t(`<h4 id="_6-4-路由规则可配置化" tabindex="-1"><a class="header-anchor" href="#_6-4-路由规则可配置化" aria-hidden="true">#</a> 6.4. 路由规则可配置化</h4><p>上述的两种方式都是把路由写到application.yml中，即然我们已经学习过nacos作为配置中心，何不利用起来呢？我们的目标是：让路由规则可配置化，下面我们进行实践操作。</p><ul><li>在gateway-demo模块的pom文件中添加nacos的配置依赖</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>把application.yml文件修改成bootstrap.yml，并配置config项</li></ul><p>我们使用nacos的共享配置文件的方式进行配置。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>demo
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> deeaeca6<span class="token punctuation">-</span>bed9<span class="token punctuation">-</span>4fb1<span class="token punctuation">-</span>b5b7<span class="token punctuation">-</span>9c79278561ca
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>

          <span class="token comment"># 日志</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> log.yml
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">group</span><span class="token punctuation">:</span> COMMON

          <span class="token comment"># 路由规则</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> routerule.yml
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">group</span><span class="token punctuation">:</span> GATEWAY

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在nacos的控制台配置上路由规则</li></ul><figure><img src="`+J+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>重新启动，测试运行结果</li></ul><p>成功，无异常。</p><h4 id="_6-5-集成swagger" tabindex="-1"><a class="header-anchor" href="#_6-5-集成swagger" aria-hidden="true">#</a> 6.5. 集成swagger</h4><p>在微服务框架中，由于会有很多个微服务，每一个微服务都有自己的一组API，虽然Spring团队为我们提供了每一个微服务自己的API展示组件——swagger，我们在使用时，只需要找到不同服务的ip和端口即可，但是在实际的开发场景中，我们希望网关上游的所有微服务的API能够聚合到一起。这样我们就需要记住网关的服务地址即可。</p>',13),Ws={href:"https://doc.xiaominfo.com/docs/action/springcloud-gateway",target:"_blank",rel:"noopener noreferrer"},Xs=t(`<blockquote><p>微信扫码关注“天晴小猪”（ID： it-come-true），回复“springcloud”，获取本章节实战源码。</p></blockquote><ul><li>创建gateway-swagger模块</li></ul><p>pom.xml引入gateway、alibaba-nacos-discovery、knife4j-spring-boot-starter三个依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.xiaoymin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>knife4j-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>application.yml中主要配置nacos的服务发现地址及网关的路由规则：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10800</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>swagger
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment">#配置路由路径</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//swagger<span class="token punctuation">-</span>user
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/swagger<span class="token punctuation">-</span>user/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//swagger<span class="token punctuation">-</span>order
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/swagger<span class="token punctuation">-</span>order/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启从注册中心动态创建路由的功能</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#使用小写服务名，默认是大写</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动类上添加服务注册与发现的注解 <code>@EnableDiscoveryClient</code> 。</p><p>添加swagger信息的资源配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Primary</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerResourceConfig</span> <span class="token keyword">implements</span> <span class="token class-name">SwaggerResourcesProvider</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GatewayProperties</span> gatewayProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> routes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有路由的ID</span>
        routeLocator<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>route <span class="token operator">-&gt;</span> routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//过滤出配置文件中定义的路由-&gt;过滤出Path Route Predicate-&gt;根据路径拼接成api-docs路径-&gt;生成SwaggerResource</span>
        gatewayProperties<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>routeDefinition <span class="token operator">-&gt;</span> routes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>routeDefinition<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>route <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            route<span class="token punctuation">.</span><span class="token function">getPredicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>predicateDefinition <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;Path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>predicateDefinition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>predicateDefinition <span class="token operator">-&gt;</span> resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">swaggerResource</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            predicateDefinition<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NameUtils</span><span class="token punctuation">.</span><span class="token constant">GENERATED_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v2/api-docs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> resources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">SwaggerResource</span> <span class="token function">swaggerResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;name:{},location:{}&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SwaggerResource</span> swaggerResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SwaggerResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        swaggerResource<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        swaggerResource<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        swaggerResource<span class="token punctuation">.</span><span class="token function">setSwaggerVersion</span><span class="token punctuation">(</span><span class="token string">&quot;2.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> swaggerResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后一步配置服务资源的转发配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 服务转发的请求处理
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">SecurityConfiguration</span> securityConfiguration<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">UiConfiguration</span> uiConfiguration<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SwaggerResourcesProvider</span> swaggerResources<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">SwaggerHandler</span><span class="token punctuation">(</span><span class="token class-name">SwaggerResourcesProvider</span> swaggerResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>swaggerResources <span class="token operator">=</span> swaggerResources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token doc-comment comment">/**
     * Swagger资源配置，微服务中这各个服务的api-docs信息
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/swagger-resources&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">swaggerResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>swaggerResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token doc-comment comment">/**
     * Swagger安全配置，支持oauth和apiKey设置
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/swagger-resources/configuration/security&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfiguration</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">securityConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>securityConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">SecurityConfigurationBuilder</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Swagger UI配置
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/swagger-resources/configuration/ui&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">UiConfiguration</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">uiConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>uiConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">UiConfigurationBuilder</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>创建swagger-user模块</li></ul><p>pom文件中引入knife4j的依赖：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>&lt;dependency<span class="token punctuation">&gt;</span>
    &lt;groupId<span class="token punctuation">&gt;</span>com.github.xiaoymin&lt;/groupId<span class="token punctuation">&gt;</span>
    &lt;artifactId<span class="token punctuation">&gt;</span>knife4j<span class="token punctuation">-</span>micro<span class="token punctuation">-</span>spring<span class="token punctuation">-</span>boot<span class="token punctuation">-</span>starter&lt;/artifactId<span class="token punctuation">&gt;</span>
    &lt;version<span class="token punctuation">&gt;</span>2.0.4&lt;/version<span class="token punctuation">&gt;</span>
&lt;/dependency<span class="token punctuation">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件中把服务注册到nacos上：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10600</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>user
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.150<span class="token punctuation">:</span><span class="token number">8848</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加swagger的配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token annotation punctuation">@EnableKnife4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Swagger2Config</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span><span class="token constant">SWAGGER_2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">basePackage</span><span class="token punctuation">(</span><span class="token string">&quot;com.tianqingxiaozhu.swaggeruser.controller&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ApiInfo</span> <span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">&quot;swagger-user&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务API文档&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contact</span><span class="token punctuation">(</span><span class="token string">&quot;tianqingxiaozhu&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后编写几个测试类即可。</p><ul><li>创建swagger-order模块</li></ul><p>swagger-order模块的搭建步骤与swagger-user模块的搭建步骤一致。不再赘述。</p><ul><li>测试</li></ul><p>分别启动swagger-user、swagger-order和gateway-swagger模块，浏览器中输入： <a href="http:_localhost:10800_doc">http://localhost:10800/doc.html</a> ，然后在服务选择框中选择想要展示的服务接口即可。</p><figure><img src="`+Z+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_6-6-其他" tabindex="-1"><a class="header-anchor" href="#_6-6-其他" aria-hidden="true">#</a> 6.6. 其他</h4><p>由于篇幅原因，网关还有很多在实际生产环境下的应用场景没有实践，这里我们先罗列一下，后续有时间再进行分享。</p><ol><li>https的使用： 一般情况下服务都是放到内网里面的，相互之间的调用使用http即可完成，但是有些api接口需要暴露到外网，而暴露给外网，https更为安全，此时又想所有的服务通过网关进行暴露，此时就涉及到https到http的转化。</li><li>在实际生产环境下，实际的实践过程是通过把路由规则配置到配置中心来完成每一步骤的调用的。在springcloud-alibaba的框架中，我们可以把路由规则配置到nacos中，使用样例如上文所示。</li><li>网关需要扛住几乎所有应该到达后端微服务的流量，那么如何保证网关上游的微服务的安全呢？此时我们就需要Sentinel的帮助了。</li><li>灰度发布有很多种实践方案，其中有一种是基于网关的实现方案。</li><li>网关+Oauth2.0进行权限认证</li><li>网关的CROS方案。</li></ol><p>后续有时间会统一进行分享。</p><h3 id="_7-总结-1" tabindex="-1"><a class="header-anchor" href="#_7-总结-1" aria-hidden="true">#</a> 7. 总结</h3><ol><li>微服务的发展过程中势必会遇到很多问题，某种意义上讲，网关的出现最早是为了解决不同组织内巨量微服务相互隔离的问题，但在后续的发展过程中，网关又逐渐有了一些新的特性。</li><li>实践了网关的基本功能——服务转发、重写路由、路由规则可配置化，以及网关的一些生产实践——集成swagger的使用等。</li><li>列举了一些生产的应用场景，后续有时间再进行分享。</li></ol><h3 id="scg-性能优化" tabindex="-1"><a class="header-anchor" href="#scg-性能优化" aria-hidden="true">#</a> SCG 性能优化</h3>',31),Qs={href:"https://zhuanlan.zhihu.com/p/614977890",target:"_blank",rel:"noopener noreferrer"},$s={href:"https://cloud.tencent.com/developer/article/1926643",target:"_blank",rel:"noopener noreferrer"},na={href:"https://blog.csdn.net/dongjia9/article/details/129624365",target:"_blank",rel:"noopener noreferrer"},sa=n("li",null,"通过文章中的源码链接，找到其他文章，确认性能测试工具为 JMH 。猜测 测试结果章节中的图应该是在Excel中生成的；",-1),aa=n("li",null,"可以下载文章中的这两个仓库进行研究；主要是性能优化及动态路由；",-1),ea={href:"https://insights.thoughtworks.cn/performance-testing-tools/",target:"_blank",rel:"noopener noreferrer"},ta={href:"https://xie.infoq.cn/article/d39fde1ce527ec2c3c6750c4c",target:"_blank",rel:"noopener noreferrer"},ia={href:"https://xie.infoq.cn/article/bebacc42bad0712638ba3231e",target:"_blank",rel:"noopener noreferrer"},la={href:"https://xie.infoq.cn/article/0ae4f61ce6c67a651d94678a8",target:"_blank",rel:"noopener noreferrer"},pa={href:"https://gitee.com/eblog/scgw-benchmark-all",target:"_blank",rel:"noopener noreferrer"},ca={href:"https://heapdump.cn/article/4436607",target:"_blank",rel:"noopener noreferrer"},oa={href:"https://juejin.cn/post/7057415444109459487",target:"_blank",rel:"noopener noreferrer"},ua=n("ol",null,[n("li",null,"可以研究一下美团的cat监控平台")],-1),da={href:"https://blog.csdn.net/manzhizhen/article/details/115386684",target:"_blank",rel:"noopener noreferrer"},ra={href:"https://blog.csdn.net/lizz861109/article/details/103972775",target:"_blank",rel:"noopener noreferrer"},ka=t('<ul><li>scg 原理</li><li>编写简单使用样例，之后进行压测</li><li>进行优化，之后再次进行压测</li><li>scg路由规则动态可配置化</li></ul><h2 id="_12-sentinel分布式限流" tabindex="-1"><a class="header-anchor" href="#_12-sentinel分布式限流" aria-hidden="true">#</a> 12. sentinel分布式限流</h2><h3 id="sentinel" tabindex="-1"><a class="header-anchor" href="#sentinel" aria-hidden="true">#</a> <strong>Sentinel</strong></h3><figure><img src="'+W+'" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>创建启动cmd脚本： java -Dserver.port=8081 -Dcsp.sentinel.dashboard.server=localhost:8081 -Dproject.name=sentinel-dashboard -jar ./sentinel-dashboard-1.7.1.jar 双击cmd脚本，打开浏览器输入 localhost:8081， 用户名和密码： sentinel / sentinel</p><h2 id="_13-seata分布式事务" tabindex="-1"><a class="header-anchor" href="#_13-seata分布式事务" aria-hidden="true">#</a> 13. seata分布式事务</h2><h3 id="_1-搭建-seata-服务端" tabindex="-1"><a class="header-anchor" href="#_1-搭建-seata-服务端" aria-hidden="true">#</a> 1. 搭建 Seata 服务端</h3><h4 id="_1-1-前置知识" tabindex="-1"><a class="header-anchor" href="#_1-1-前置知识" aria-hidden="true">#</a> 1.1. 前置知识</h4><p>在了解Seata之前，请先熟悉一下分布式事务的相关知识——<a href="./spring/seata_distribute-transaction">分布式事务概述</a>。简单熟悉一下XA模式、两阶段提交、三阶段提交、TCC、Seaga等概念及原理。</p>',9),va={href:"https://seata.io",target:"_blank",rel:"noopener noreferrer"},ma=n("p",null,"Seata的用法其实很简单，我们类比于在SpringBoot项目中使用Mysql的方式——先部署一个Mysql服务器实例，然后SpringBoot项目中引入依赖，之后在配置文件中配置好Mysql的相关连接信息，之后启动即可使用，在SpringBoot项目中使用Seata的方式也很简单：",-1),ba=n("ol",null,[n("li",null,"搭建一个Seata的服务器实例，这个服务器实例承担的角色是TC的角色，即事务管理器的角色；"),n("li",null,"在SpringBoot项目中引入依赖；"),n("li",null,"在配置文件中配置好Seata的相关信息；")],-1),ga=n("p",null,"我们结合XA理论可知，Seata服务器端实例承载着事务管理器的角色，它承担着统一管理各个『参与者』提交事务、回滚事务的职责；而参与分布式事务的各个『参与者』就是AP的角色，它们则是具体的业务实现，底层连接着数据库，而数据库就是资源管理器（CRM）的角色。",-1),ha=n("p",null,"因此，要基于Seata完成分布式事务的实现，就必须先要搭建一个Seata服务端实例。",-1),fa=n("p",null,"由于Seata也是JAVA项目，并且支持多种配置方式和持久化方式，这里我们选择基于Nacos和Mysql的方式。其他方式可以自行查看官网。",-1),ya=n("p",null,"因此有一个前置条件，要先把Mysql和Nacos启动起来。此外，我们还需要用到源码文件夹下面的一些脚本。因此我们还需要下载相对应版本的源代码。",-1),_a={href:"https://github.com/seata/seata/releases/download/v1.3.0/seata-server-1.3.0.tar.gz",target:"_blank",rel:"noopener noreferrer"},xa={href:"https://github.com/seata/seata/tree/master/script",target:"_blank",rel:"noopener noreferrer"},wa=t('<p>总结一下：</p><ol><li>启动Mysql</li><li>启动Nacos</li><li>下载服务器端压缩包</li><li>下载源代码中的脚本</li></ol><h4 id="_1-2-搭建过程" tabindex="-1"><a class="header-anchor" href="#_1-2-搭建过程" aria-hidden="true">#</a> 1.2. 搭建过程</h4><h5 id="_1-2-1-解压" tabindex="-1"><a class="header-anchor" href="#_1-2-1-解压" aria-hidden="true">#</a> 1.2.1. 解压</h5><p>安装包下载完成之后，上传到服务器上，并完成解压。解压后的文件目录如下：</p><figure><img src="'+X+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1-2-2-执行脚本" tabindex="-1"><a class="header-anchor" href="#_1-2-2-执行脚本" aria-hidden="true">#</a> 1.2.2. 执行脚本</h5><p>Seata本身也是一个项目，这个执行脚本的过程，本质上就是对Seata进行一个配置。执行脚本有两个步骤，一个是Seata在管理分布式事务时，需要依赖数据库保存一些关键信息；一个是需要导入Seata项目的一些配置信息。<strong>此外，这两个脚本都是在源码项目下面的。</strong></p><p>步骤一，在下载下来的源代码目录下，找到/script/server/db/下面的mysql的脚本，并在mysql中进行执行。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------\n-- the table to store GlobalSession data\nCREATE TABLE IF NOT EXISTS `global_table`\n(\n    `xid`                       VARCHAR(128) NOT NULL,\n    `transaction_id`            BIGINT,\n    `status`                    TINYINT      NOT NULL,\n    `application_id`            VARCHAR(32),\n    `transaction_service_group` VARCHAR(32),\n    `transaction_name`          VARCHAR(128),\n    `timeout`                   INT,\n    `begin_time`                BIGINT,\n    `application_data`          VARCHAR(2000),\n    `gmt_create`                DATETIME,\n    `gmt_modified`              DATETIME,\n    PRIMARY KEY (`xid`),\n    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),\n    KEY `idx_transaction_id` (`transaction_id`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n-- the table to store BranchSession data\nCREATE TABLE IF NOT EXISTS `branch_table`\n(\n    `branch_id`         BIGINT       NOT NULL,\n    `xid`               VARCHAR(128) NOT NULL,\n    `transaction_id`    BIGINT,\n    `resource_group_id` VARCHAR(32),\n    `resource_id`       VARCHAR(256),\n    `branch_type`       VARCHAR(8),\n    `status`            TINYINT,\n    `client_id`         VARCHAR(64),\n    `application_data`  VARCHAR(2000),\n    `gmt_create`        DATETIME(6),\n    `gmt_modified`      DATETIME(6),\n    PRIMARY KEY (`branch_id`),\n    KEY `idx_xid` (`xid`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n-- the table to store lock data\nCREATE TABLE IF NOT EXISTS `lock_table`\n(\n    `row_key`        VARCHAR(128) NOT NULL,\n    `xid`            VARCHAR(96),\n    `transaction_id` BIGINT,\n    `branch_id`      BIGINT       NOT NULL,\n    `resource_id`    VARCHAR(256),\n    `table_name`     VARCHAR(32),\n    `pk`             VARCHAR(36),\n    `gmt_create`     DATETIME,\n    `gmt_modified`   DATETIME,\n    PRIMARY KEY (`row_key`),\n    KEY `idx_branch_id` (`branch_id`)\n) ENGINE = InnoDB\n  DEFAULT CHARSET = utf8;\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="'+Q+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>步骤二，导入Seata项目的一些配置信息到nacso上去，由于配置项比较多，官方提供了使用脚本进行导入的方式，这个过程可能需要具备一些Nacos的基本知识。</p><p>但是由于我们使用的配置方式是基于mysql和nacos的，因此，我们还需要先修改一下配置信息。我们打开 /script/config-center/ 下面的 config.txt 文件，之后修改下面的几项内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
store.mode=db ## 采用db的存储形式 
store.db.datasource=druid ## druid数据源 
store.db.dbType=mysql ## mysql数据库 
store.db.driverClassName=com.mysql.jdbc.Driver ## mysql驱动 
store.db.url=jdbc:mysql://192.168.1.150:3306/seata_server?useUnicode=true ## TC的数据库url 
store.db.user=root ## 用户名 
store.db.password=root ## 密码

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后只需要在 /script/config-center/nacos/ 目录下执行下面命令即可。Windows平台下面，可以使用gitbash执行。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sh nacos-config.sh -h 192.168.1.150 -p 8848 -g SEATA_GROUP -t bb4ba084-9183-4406-bdf4-9254d372849e -u nacos -w nacos

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>执行后的效果如下：</p><figure><img src="`+$+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1-2-3-修改项目中的配置文件" tabindex="-1"><a class="header-anchor" href="#_1-2-3-修改项目中的配置文件" aria-hidden="true">#</a> 1.2.3. 修改项目中的配置文件</h5><p>完成上面的两个步骤之后，Seata的基础环境已经完成了，下面需要配置Seata项目的启动信息，主要是： 让Seata服务实例注册到nacos上 和 让Seata找到Nacos上的配置信息 ，也很简单，<strong>只需要修改安装包下面的 conf/registry.conf 文件中的nacos部分即可</strong>。修改后的结果如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>## 【说明】文件有两部分，一个是registry，表示Seata服务端程序注册到哪里，这里我们把type配置成nacos，然后修改nacos的连接信息即可。
##      另一部分是config，表示Seata服务端程序的配置信息放在哪里，同样的，我们把type改成nacos，然后修改nacos的连接信息即可。

registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;nacos&quot;

  nacos {
    application = &quot;seata-server&quot;
    serverAddr = &quot;192.168.1.150:8848&quot;
    group = &quot;SEATA_GROUP&quot;
    namespace = &quot;bb4ba084-9183-4406-bdf4-9254d372849e&quot;
    cluster = &quot;default&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
  eureka {
    serviceUrl = &quot;http://localhost:8761/eureka&quot;
    application = &quot;default&quot;
    weight = &quot;1&quot;
  }
  redis {
    serverAddr = &quot;localhost:6379&quot;
    db = 0
    password = &quot;&quot;
    cluster = &quot;default&quot;
    timeout = 0
  }
  zk {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:2181&quot;
    sessionTimeout = 6000
    connectTimeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  consul {
    cluster = &quot;default&quot;
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  etcd3 {
    cluster = &quot;default&quot;
    serverAddr = &quot;http://localhost:2379&quot;
  }
  sofa {
    serverAddr = &quot;127.0.0.1:9603&quot;
    application = &quot;default&quot;
    region = &quot;DEFAULT_ZONE&quot;
    datacenter = &quot;DefaultDataCenter&quot;
    cluster = &quot;default&quot;
    group = &quot;SEATA_GROUP&quot;
    addressWaitTime = &quot;3000&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}

config {
  # file、nacos 、apollo、zk、consul、etcd3
  type = &quot;nacos&quot;

  nacos {
    serverAddr = &quot;192.168.1.150:8848&quot;
    namespace = &quot;bb4ba084-9183-4406-bdf4-9254d372849e&quot;
    group = &quot;SEATA_GROUP&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
  consul {
    serverAddr = &quot;127.0.0.1:8500&quot;
  }
  apollo {
    appId = &quot;seata-server&quot;
    apolloMeta = &quot;http://192.168.1.204:8801&quot;
    namespace = &quot;application&quot;
  }
  zk {
    serverAddr = &quot;127.0.0.1:2181&quot;
    sessionTimeout = 6000
    connectTimeout = 2000
    username = &quot;&quot;
    password = &quot;&quot;
  }
  etcd3 {
    serverAddr = &quot;http://localhost:2379&quot;
  }
  file {
    name = &quot;file.conf&quot;
  }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-4-启动" tabindex="-1"><a class="header-anchor" href="#_1-2-4-启动" aria-hidden="true">#</a> 1.2.4. 启动</h5>`,22),Sa={href:"http://seata-server.sh",target:"_blank",rel:"noopener noreferrer"},Ea=t('<figure><img src="'+nn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看日志中，已经成功启动。</p><figure><img src="'+sn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>再去nacos上看看，服务实例已经启动，并注册到了Nacos上了。</p><figure><img src="'+an+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_2-at-模式实战" tabindex="-1"><a class="header-anchor" href="#_2-at-模式实战" aria-hidden="true">#</a> 2. AT 模式实战</h3><h4 id="_2-1-使用场景" tabindex="-1"><a class="header-anchor" href="#_2-1-使用场景" aria-hidden="true">#</a> 2.1. 使用场景</h4><p>举一个简单的应用场景：电商系统中，一个用户发起购买商品的动作，后端业务逻辑是</p><ul><li>扣减库存</li><li>扣减个人账户上的余额</li><li>创建一个订单</li></ul><p>只要上面有一个步骤没有执行成功，就回滚已经执行成功的其他步骤。为了模拟分布式事务的效果，我们采用创建三个微服务的方式实现。</p><ol><li>seata-at-storage 库存服务</li><li>seata-at-account 账户服务</li><li>seata-at-order 订单服务</li></ol><p>所以上面的业务逻辑就变成了，用户发起一个购买商品的服务，直接调用后端 订单服务 ，由订单服务分别调用 库存服务 完成扣减库存功能，然后再调用 账户服务 完成扣减账户金额功能，最后本地生成一个订单。</p><p>这里我们需要一个注册中心，把三个服务注册到上面，这样配合OpenFeign完成相互调用，此外我们还需要MySQL作为数据存储，最后我们需要Seata作为我们的事务管理器。</p><h4 id="_2-2-搭建seata-at-storage服务模块" tabindex="-1"><a class="header-anchor" href="#_2-2-搭建seata-at-storage服务模块" aria-hidden="true">#</a> 2.2. 搭建seata-at-storage服务模块</h4><ol><li>先创建数据库</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-- 仓储
CREATE TABLE \`storage\` (
  \`id\` bigint(11) NOT NULL AUTO_INCREMENT,
  \`name\` varchar(100) DEFAULT NULL,
  \`num\` bigint(11) DEFAULT NULL COMMENT &#39;数量&#39;,
  \`create_time\` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
  \`price\` bigint(10) DEFAULT NULL COMMENT &#39;单价，单位分&#39;,
  PRIMARY KEY (\`id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT;

CREATE TABLE \`undo_log\` (
  \`branch_id\` bigint(20) NOT NULL COMMENT &#39;branch transaction id&#39;,
  \`xid\` varchar(100) NOT NULL COMMENT &#39;global transaction id&#39;,
  \`context\` varchar(128) NOT NULL COMMENT &#39;undo_log context,such as serialization&#39;,
  \`rollback_info\` longblob NOT NULL COMMENT &#39;rollback info&#39;,
  \`log_status\` int(11) NOT NULL COMMENT &#39;0:normal status,1:defense status&#39;,
  \`log_created\` datetime(6) NOT NULL COMMENT &#39;create datetime&#39;,
  \`log_modified\` datetime(6) NOT NULL COMMENT &#39;modify datetime&#39;,
  UNIQUE KEY \`ux_undo_log\` (\`xid\`,\`branch_id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT COMMENT=&#39;AT transaction mode undo table&#39;;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用idea工具中的initializer工具，生成模块的骨架，这里不再赘述。</li><li>修改pom文件，添加上 nacos注册中心、Mybatis、MySQL、Seata的相关依赖。</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;!-- mysql --&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;!--seata--&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
    &lt;exclusions&gt;
      &lt;!-- 排除依赖 指定版本和服务器端一致 --&gt;
      &lt;exclusion&gt;
        &lt;groupId&gt;io.seata&lt;/groupId&gt;
        &lt;artifactId&gt;seata-all&lt;/artifactId&gt;
      &lt;/exclusion&gt;
      &lt;exclusion&gt;
        &lt;groupId&gt;io.seata&lt;/groupId&gt;
        &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
      &lt;/exclusion&gt;
    &lt;/exclusions&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;io.seata&lt;/groupId&gt;
    &lt;artifactId&gt;seata-all&lt;/artifactId&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;io.seata&lt;/groupId&gt;
    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>修改项目的配置： application.yml</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>server:
  port: 10902

spring:
  application:
    name: seata-at-storage
  datasource:
    url: jdbc:mysql://192.168.1.150:3306/seata_storage?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      auto-commit: true
      connection-test-query: SELECT 1
      connection-timeout: 30000
      idle-timeout: 180000
      max-lifetime: 0
      maximum-pool-size: 30
      minimum-idle: 10
      pool-name: hikari-pool
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.1.150:8848
        namespace: 2cbceeeb-22f5-40d6-b65c-47f673e79f29


mybatis:
  mapper-locations: classpath:/mapper/*.xml

# 配置日志级别
logging:
  level:
    root: debug

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>之后再使用idea中的easycode插件生成业务代码，关键方法是： <code>me.zeanzai.seataatstorage.service.impl.StorageServiceImpl#deduct</code></li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean deduct(Long id, Long num) {
    //todo 模拟扣减库存，具体业务逻辑自己完善
    Storage storage = this.storageDao.queryById(id);
    if (Objects.isNull(storage))
        throw new RuntimeException();

    storage.setNum(storage.getNum()-num);

    return this.storageDao.update(storage) &gt; 0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-搭建seata-at-account和seata-at-order服务模块" tabindex="-1"><a class="header-anchor" href="#_2-3-搭建seata-at-account和seata-at-order服务模块" aria-hidden="true">#</a> 2.3. 搭建seata-at-account和seata-at-order服务模块</h4><p>搭建过程与上面的seata-at-storage服务模块的过程基本类似。</p><p>seata-at-account的表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>
<span class="token comment">-- 账户余额</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>account<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">32</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用 户userId&#39;</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">\`</span>money<span class="token punctuation">\`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额，单位分&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>create_time<span class="token punctuation">\`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>context<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>rollback_info<span class="token punctuation">\`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>log_modified<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>ux_undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>COMPACT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>seata-at-order服务模块的表结构：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>

-- 订单
CREATE TABLE \`ordertb\` (
  \`id\` bigint(11) NOT NULL AUTO_INCREMENT,
  \`product_id\` bigint(11) DEFAULT NULL COMMENT &#39;商品Id&#39;,
  \`num\` bigint(11) DEFAULT NULL COMMENT &#39;数量&#39;,
  \`user_id\` varchar(32) DEFAULT NULL COMMENT &#39;用户唯一Id&#39;,
  \`create_time\` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
  \`status\` int(1) DEFAULT NULL COMMENT &#39;订单状态 1 未付款 2 已付款 3 已完成&#39;,
  PRIMARY KEY (\`id\`) USING BTREE
) ENGINE=InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci  ROW_FORMAT=COMPACT;

CREATE TABLE \`undo_log\` (
  \`branch_id\` bigint(20) NOT NULL COMMENT &#39;branch transaction id&#39;,
  \`xid\` varchar(100) NOT NULL COMMENT &#39;global transaction id&#39;,
  \`context\` varchar(128) NOT NULL COMMENT &#39;undo_log context,such as serialization&#39;,
  \`rollback_info\` longblob NOT NULL COMMENT &#39;rollback info&#39;,
  \`log_status\` int(11) NOT NULL COMMENT &#39;0:normal status,1:defense status&#39;,
  \`log_created\` datetime(6) NOT NULL COMMENT &#39;create datetime&#39;,
  \`log_modified\` datetime(6) NOT NULL COMMENT &#39;modify datetime&#39;,
  UNIQUE KEY \`ux_undo_log\` (\`xid\`,\`branch_id\`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT COMMENT=&#39;AT transaction mode undo table&#39;;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>扣减金额的关键代码， <code>me.zeanzai.seataataccount.service.impl.AccountServiceImpl#deduct</code> ：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean deduct(String userId, Long money) {
    Account account = this.accountDao.queryByUserId(userId);
    if (Objects.isNull(account)) {
        return false;

    }
    account.setMoney(account.getMoney()-money);
    return this.accountDao.update(account)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 seata-at-order 服务模块中需要使用OpenFeign来调用仓储和账户服务，因此还需要创建两个接口：</p><figure><img src="`+en+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@FeignClient(value = &quot;seata-at-account&quot;)
public interface AccountFeignClient {

    @PostMapping(&quot;/account/deduct&quot;)
    boolean deduct(@RequestParam(&quot;userId&quot;) String userId,
                   @RequestParam(&quot;money&quot;) Long money);

}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@FeignClient(value = &quot;seata-at-storage&quot;)
public interface StorageFeignClient {

    @GetMapping(&quot;/storage/{id}&quot;)
    ResponseEntity&lt;Storage&gt; queryById(@PathVariable(&quot;id&quot;) Long id);

    @PostMapping(&quot;/storage/deduct&quot;)
    boolean deduct(@RequestParam(&quot;id&quot;) Long id,
                   @RequestParam(&quot;num&quot;) Long num);
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后就是生成订单的关键代码， <code>me.zeanzai.seataatorder.service.impl.OrdertbServiceImpl#createOrder</code> ：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Transactional
@Override
public boolean createOrder(String userId, Long productId, Long num) {
    // 1. 扣减库存
    storageFeignClient.deduct(productId, num);

    // 2. 扣减余额
    ResponseEntity&lt;Storage&gt; storageResponseEntity = storageFeignClient.queryById(productId);
    Storage body = storageResponseEntity.getBody();
    accountFeignClient.deduct(userId, body.getPrice() * num);
    // 3. 创建订单
    Ordertb ordertb = new Ordertb();
    ordertb.setNum(num);
    ordertb.setUserId(userId);
    ordertb.setProductId(productId);
    ordertb.setStatus(2);
    return this.ordertbDao.insert(ordertb)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-启动并测试" tabindex="-1"><a class="header-anchor" href="#_2-4-启动并测试" aria-hidden="true">#</a> 2.4. 启动并测试</h4><p>分别启动 seata-at-storage 、 seata-at-account 、seata-at-order 模块，我们会发现已经注册到nacos上了。</p><figure><img src="`+tn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>之后我们只需要调用订单模块中的createOrder接口就行了。</p><p>特别注意的点：三个服务模块中都只是使用<code>@Transactional</code>标注了本地事务，并没有开始分布式事务。</p><h4 id="_2-5-整合seata" tabindex="-1"><a class="header-anchor" href="#_2-5-整合seata" aria-hidden="true">#</a> 2.5. 整合Seata</h4><p>直到这一步，我们跟Seata没有任何关系，因为我们生成订单的方法中并没有定义事务，只是简单的本地事务，在生成订单的接口中，如果扣减库存的接口出现超时等异常错误信息，扣减金额和生成订单的逻辑并不会回滚。下面我们来说整合Seata的过程。安装和配置Seata这里就不再赘述。</p><ol><li>首先要先启动Seata</li></ol><figure><img src="'+ln+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>在三个模块中分别添加Seata的配置</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>seata:
  enabled: true
  application-id: \${spring.application.name}
  tx-service-group: \${spring.application.name}-tx-group
  config:
    type: nacos
    nacos:
      namespace: bb4ba084-9183-4406-bdf4-9254d372849e
      server-addr: 192.168.1.150:8848
      group: SEATA_GROUP
      username: nacos
      password: nacos
  registry:
    type: nacos
    nacos:
      application: seata-server
      namespace: bb4ba084-9183-4406-bdf4-9254d372849e
      server-addr: 192.168.1.150:8848
      group: SEATA_GROUP
      username: nacos
      password: nacos

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>创建Seata服务端配置，这里要特别注意：值均为default。</li></ol><figure><img src="`+pn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+cn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+on+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+un+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>修改业务代码，在订单模块中设置生成订单的方法为全局事务</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Override
@GlobalTransactional
public boolean createOrder(String userId, Long productId, Long num) {
    // 1. 扣减库存
    storageFeignClient.deduct(productId, num);

    // 2. 扣减余额
    ResponseEntity&lt;Storage&gt; storageResponseEntity = storageFeignClient.queryById(productId);
    Storage body = storageResponseEntity.getBody();
    accountFeignClient.deduct(userId, body.getPrice() * num);
    // 3. 创建订单
    Ordertb ordertb = new Ordertb();
    ordertb.setNum(num);
    ordertb.setUserId(userId);
    ordertb.setProductId(productId);
    ordertb.setStatus(2);
    return this.ordertbDao.insert(ordertb)&gt;0;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>启动测试</li></ol><figure><img src="`+dn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+rn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-tcc-模式实战" tabindex="-1"><a class="header-anchor" href="#_3-tcc-模式实战" aria-hidden="true">#</a> 3. TCC 模式实战</h3><ol><li>搭建公共模块，并搭建三个基本服务，完成三个模块的接口测试；</li><li>保证三个异常</li></ol><p>第一阶段： 搭建基础环境，只提供操作数据库的方法； 第二阶段： 完成order模块调用另外两个模块的rpc调用过程，需要集成nacos、openfeign等工具包； 第三阶段： 集成Seata；</p><p>starter模块用来统一管理各种依赖的版本； common模块继承starter模块，并包含公共模块，但是不传递依赖，如Seata的依赖，如果只在业务包里面使用，那么Seata的依赖就应该放到业务模块里面；</p><p>遵循： 1. 用到才添加依赖，不传递；</p><p>storage、account、order都继承starter模块，并继承starter模块，依赖于common模块；</p><ol><li>需要解决空回滚</li><li>悬挂</li><li>幂等</li></ol><p>// todo // 1. 单测已经完成，但是压测没有通过，大批量请求进入时，并不能保证数据的一致性； // 2. 码猿技术专栏教程中的项目代码，压测时，也不能保证数据的一致性； // 3. 参考网上一篇文章，完成了异常编码集中化配置的使用方式，但是理想是把配置文件整到配置中心去；</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>storage<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;单价，单位分&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>frozen<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;冻结的库存&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n	<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n	<span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">32</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用 户userId&#39;</span><span class="token punctuation">,</span>\n	<span class="token identifier"><span class="token punctuation">`</span>money<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额，单位分&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n\n  <span class="token identifier"><span class="token punctuation">`</span>frozen<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;冻结的money&#39;</span><span class="token punctuation">,</span>\n	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span> \n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_order<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;商品Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户唯一Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单状态 1 未付款 2 已付款 3 已完成 4 待确认 5 已删除&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>ordertb<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;商品Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户唯一Id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单状态 1 未付款 2 已付款 3 已完成 4 待确认 5 已删除&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci  ROW_FORMAT<span class="token operator">=</span>COMPACT<span class="token punctuation">;</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>压力测试时用到的一些脚本</p><p>-- 初始化 delete from <code>seata_server</code>.<code>branch_table</code>; delete from <code>seata_server</code>.<code>global_table</code>; delete from <code>seata_server</code>.<code>lock_table</code>; delete from <code>seata_tcc_account</code>.<code>account</code>; delete from <code>seata_tcc_account</code>.<code>undo_log</code>; delete from <code>seata_tcc_storage</code>.<code>storage</code>; delete from <code>seata_tcc_storage</code>.<code>undo_log</code>; delete from <code>seata_tcc_order</code>.<code>ordertb</code>; delete from <code>seata_tcc_order</code>.<code>undo_log</code>; delete from <code>seata_tcc_order</code>.<code>transactional_record</code>; INSERT INTO <code>seata_tcc_account</code>.<code>account</code> (<code>id</code>, <code>user_id</code>, <code>money</code>, <code>create_time</code>, <code>frozen</code>) VALUES (1, &#39;1&#39;, 20000, &#39;2023-03-21 16:46:58&#39;, 0); INSERT INTO <code>seata_tcc_storage</code>.<code>storage</code> (<code>id</code>, <code>product_id</code>, <code>name</code>, <code>num</code>, <code>create_time</code>, <code>price</code>, <code>frozen</code>) VALUES (1, 100, &#39;码猿技术专栏&#39;, 1000, &#39;2021-10-15 22:32:40&#39;, 20, 0);</p><p>select * from <code>seata_tcc_account</code>.<code>account</code>; select * from <code>seata_tcc_storage</code>.<code>storage</code>; select * from <code>seata_tcc_order</code>.<code>ordertb</code>; select * from <code>seata_tcc_order</code>.<code>transactional_record</code>; select * from <code>seata_tcc_storage</code>.<code>undo_log</code>; select * from <code>seata_tcc_account</code>.<code>undo_log</code>; select * from <code>seata_tcc_order</code>.<code>undo_log</code>;</p><p>-- 花的钱： select (20000-money) as cost from <code>seata_tcc_account</code>.<code>account</code>;</p><p>-- 卖的产品个数： select (1000-num) as productNum from <code>seata_tcc_storage</code>.<code>storage</code>;</p><p>-- 订单个数 select count(1) as orderNum, count(1)_2 as productNum, count(1)_40 as moneyCost from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3;</p><p>select a.cost=o.moneyCost, s.productNum=o.productNum1 from (select (20000-money) as cost from <code>seata_tcc_account</code>.<code>account</code>) a, (select (1000-num) as productNum from <code>seata_tcc_storage</code>.<code>storage</code>) s, (select count(1)_2 as productNum1, count(1)_40 as moneyCost from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3) o ;</p><p>-- 订单上的产品个数： select sum(num) from <code>seata_tcc_order</code>.<code>ordertb</code> where <code>status</code>=3; select count(*) from <code>seata_tcc_order</code>.<code>transactional_record</code>;</p><h3 id="_4-实践过程" tabindex="-1"><a class="header-anchor" href="#_4-实践过程" aria-hidden="true">#</a> 4. 实践过程</h3><blockquote><p>使用jpa作为ORM框架； 框架是一步一步进行迭代的。</p></blockquote><ol><li>搭建项目脚手架</li><li>集成Openfeign</li><li>集成Seata</li><li>处理三个异常信息</li><li>处理幂等性问题</li><li>查看GitHub上的samples，对服务调用也要进行幂等的问题？会不会可以处理压测时出现的问题</li></ol><hr><h3 id="_5-tcc模式" tabindex="-1"><a class="header-anchor" href="#_5-tcc模式" aria-hidden="true">#</a> 5. TCC模式</h3><h4 id="_5-1-1-空回滚和悬挂问题的分析" tabindex="-1"><a class="header-anchor" href="#_5-1-1-空回滚和悬挂问题的分析" aria-hidden="true">#</a> 5.1. 1.空回滚和悬挂问题的分析</h4><p>这一节，我们来看下生单链路中，引入Seata TCC后可能会导致的一些问题，在TCC分布式事务中，最常见的问题莫过于空回滚和悬挂了，Seata TCC分布式事务也是如此。</p><p>我们先来结合着上节课的生单链路，了解下什么是空回滚和悬挂：</p><figure><img src="'+kn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，当用户提交订单时，订单系统向Seata Server发送一个请求，开启一个分布式事务，并获取分布式事务对应的xid，然后订单系统通过dubbo，向库存系统发送一个rpc请求并传递相应的xid，请求锁定库存。</p><p>库存系统收到订单系统发送过来的xid，会在xid对应的分布式事务下，开启一个分支事务，然后调用系统中数据库缓存双写的逻辑。</p><p>在Seata TCC分布式事务中，会依次执行每个接口中的try方法，对一些资源进行预留，比如我们这里锁定库存，根据前面的约定，try方法中就是先扣减销售库存：</p><p>而第一个可能出现的问题，就是在调用try方法时，可能因为网络不通畅等原因，导致try方法调用时阻塞住，一直卡在半路当中，此时，销售库存的数据，当然也就没来得及扣减成功。</p><figure><img src="'+vn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这个时候，Seata TCC可能还误以为写库接口中的try方法，已经执行成功了，这个时候，Seata TCC还没等到写库接口的try方法执行成功，就开始执行写缓存接口中的try方法：</p><p>可以看到，在执行写缓存接口中的try方法时，倘若是出现了任何异常的情况，根据我们前面分析的，此时，出现异常的方法，就会原地进行本地事务回滚，Seata TCC同时也会调用写库接口中的cancel方法进行回滚。</p><figure><img src="'+mn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>现在最大的问题在于，写库接口中的try方法，前面因为网络不通畅等问题，还没来得及执行成功，此时，Seata TCC就要调用写库接口的cancel方法进行回滚，对销售库存进行增加，这样就会导致销售库存，莫名其妙多出了一些库存数据，整体的库存数据就不一致了。</p><p>像这样由于网络不通畅等原因，导致在try方法都还没有执行成功的前提下，就直接执行cancel方法进行回滚的现象，我们称为空回滚，而try方法一直阻塞卡住而不能执行的现象，一般也被称为是悬挂，不管是空回滚还是悬挂，这个两个问题的出现，根据我们刚分析的，都存在一定的概率，导致库存数据的不一致。</p><h4 id="_5-2-2-seata-tcc中的幂等性问题分析" tabindex="-1"><a class="header-anchor" href="#_5-2-2-seata-tcc中的幂等性问题分析" aria-hidden="true">#</a> 5.2. 2.Seata TCC中的幂等性问题分析</h4><p>除了可能会导致空回滚和悬挂之外，Seata TCC的引入同样也会导致幂等性问题的发生：</p><p>可以看到，倘若各个接口的try方法，现在都执行成功了，接下来，Seata TCC就会依次调用各个接口中的confirm方法，完成核心的业务逻辑。</p><figure><img src="'+bn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Seata TCC底层，一旦发现所有接口的try方法都执行成功，就会依次调用各个接口confirm方法，如果confirm方法执行失败，Seata TCC底层就会重复调用接口的confirm方法，务必确保每个接口的confirm方法，一定能执行成功。</p><p>这样的话，confirm方法就会存在一定的概率被重复调用，如图，一旦confirm方法被重复调用，锁定库存的数据就有可能被重复累加，进而导致库存数据的不一致性问题发生，所以，这算是Seata TCC分布式事务中，一个比较典型的幂等性问题了。</p><p>相应的，如果Seata TCC操作出现异常，也会导致幂等性问题的发生：</p><p>可以看到，如果写缓存接口的try方法执行失败了，写库接口这里，相应的会调用cancel方法进行回滚操作，而cancel方法的调用和confirm方法的规律是类似的，Seata TCC底层也有可能会出现重复调用，导致销售库存重复累加，进而导致库存数据的不一致性问题发生。</p><p>所以，我们可以看到，在Seata TCC分布式事务中，不论是调用confirm方法还是调用cancel方法，都存在一定的概率重复调用，也就是说confirm方法调用和cancel方法调用，都存在幂等性的问题。</p><figure><img src="'+gn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_5-3-3-如何解决空回滚、悬挂以及幂等性问题呢" tabindex="-1"><a class="header-anchor" href="#_5-3-3-如何解决空回滚、悬挂以及幂等性问题呢" aria-hidden="true">#</a> 5.3. 3.如何解决空回滚、悬挂以及幂等性问题呢？</h4><p>我们先来分析下空回滚和悬挂的问题，看下有没有好的解决方案。 首先，空回滚和悬挂问题发生的主要原因，在于try方法都还没有执行成功，cancel方法就被调用了，导致平白无故就多补偿了一次，库存数据当然就会不一致性，所以，要是cancel方法在开始执行时，就能知道try方法是否执行成功了，问题不就好办多了吗。</p><p>基于这样的设想，我们可以在内存中设计一个缓存，比如，我们可以通过Map这样的数据结构来实现，Map中的key为接口名称、分布式事务的xid和以及商品的sku组成，表示当前是哪个接口类，在哪个Seata分布式事务中，对哪个商品sku进行锁定库存操作。</p><p>而Map中的value值，则可以用于存放具体的操作状态，比如try操作开始执行时，可以在缓存中设置“TRY_START”字符串，表示当前try方法开始执行了；而当try方法执行成功之后，可以将该value值设置为“TRY_SUCESS”字符串，表示当前try方法已经执行成功了。</p><p>接下来，我们结合着生单链路，来看下具体是如何结合缓存，来解决空回滚和悬挂问题的：</p><p>首先，在cancel方法刚开始执行时，首先到缓存中检查一下，通过接口名称+xid+sku拼接成一个key，到Map缓存中查询一下，先看下能够获取到try方法执行过的痕迹。</p><p>如果try方法都还没有执行，得到的value结果肯定就为null，此时，cancel方法中的逻辑就直接取消执行，避免空回滚逻辑的执行。</p><figure><img src="'+hn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>并且，因为当前try方法都还没有开始执行就调用cancel方法了，空回滚的问题就已经发生了，所以，我们可以事先在数据库中自定义一张表，专门用来存放空回滚的记录。</p><p>空回滚发生的同时，我们可以在数据库中，及时插入一条空回滚的记录，这样，接下来一旦try方法由于网络而恢复执行了，就可以利用数据库的空回滚记录，控制try方法的执行了，我们具体来看下：</p><figure><img src="'+fn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，try方法执行时，首先会到数据库中检查一下，如果发现当前已经出现空回滚了，try方法就算恢复网络也不会被允许实际的去执行了，直接就取消try方法的执行了，通过以上这套思路，空回滚和悬挂的问题也就解决了。</p><p>空回滚和悬挂的问题解决了之后，confirm方法和cancel方法的幂等性问题，自然也就简单多了，前面我们分析过，当try方法开始执行时，会在缓存中以接口名称+xid+sku拼接的字符串为key，以“TRY_START”为value，一旦try方法执行完毕，value值就会被更新为“TRY_SUCESS”。</p><p>如果出现多个请求，重复调用confirm方法或者是cancel方法，首先得要检查下缓存中的value，是否为“TRY_SUCESS”，只有当try方法被执行了，且try方法还执行成功了，才允许执行confirm或cancel方法，否则，直接取消当前的方法。</p><p>毕竟，try方法都还没有执行成功，贸然就执行confirm方法和cancel方法，肯定是会存在问题的，这也是前面幂等性问题的核心。</p><p>而当confirm方法或cancel方法都执行完毕之后，缓存中的try方法执行标识也会及时清理掉，下一次有重复的请求过来时，缓存中就找不到try方法执行的痕迹了，confirm或者cancel方法也就不会被重复执行了，幂等性问题同样也就得以解决了。</p><h4 id="_5-4-4-总结" tabindex="-1"><a class="header-anchor" href="#_5-4-4-总结" aria-hidden="true">#</a> 5.4. 4.总结</h4><p>这一节，我们分析了在引入Seata TCC分布式事务后的生单链路中，什么是空回滚和悬挂问题。 其实，空回滚主要是try方法由于网络问题，一直都还没有开始执行，阻塞在了半路上，也就是出现了悬挂；此时，其他的Seata TCC分支链路如果恰好又出现了故障，就会导致在try方法还没有执行的前提下，就执行cancel方法，进行空回滚补偿，所以，一般都是因为悬挂而导致了空回滚的发生。</p><p>另外，如果所有接口的try方法都执行成功了，Seata TCC可能存在重复调用confirm方法或cancel方法的象，当然，Seata TCC的初衷，还是为了保证在try方法都执行成功的前提下，confirm方法或者cancel方法务必得要执行成功，因为，也带来了幂等性问题的风险。</p><p>最后，我们通过引入一个Map数据结构的缓存，及时记录当前try方法的执行情况，并且，当空回滚发生时，及时在数据库表中，记录空回滚的记录，这样，一旦发生了空回滚的问题，try方法在执行时也能及时感知到，避免了错误执行下去。</p><p>并且，正是因为我们添加了缓存，来记录try方法的执行状态，所以，只有当try方法执行成功后，才允许执行confirm方法或cancel方法，一旦执行完confirm或cancel方法，就会及时在缓存中清除try方法执行的记录，所以，confirm方法或cancel方法，能够保证只允许执行一次，完美解决了confirm和cancel方法重复执行的幂等性问题。</p><p>接着，订单系统在锁定库存时，就会调用库存系统的接口，此时，订单系统底层会通过dubbo，向库存系统发送一个远程的rpc网络请求，并将分布式事务的xid也传递过去。</p><h4 id="_5-5-生单链路核心执行流程的回顾" tabindex="-1"><a class="header-anchor" href="#_5-5-生单链路核心执行流程的回顾" aria-hidden="true">#</a> 5.5. 生单链路核心执行流程的回顾</h4><p>首先，我们来回顾下引入Seata TCC分布式事务后，生单核心链路的执行流程，想必大家现在已经很熟悉了：</p><p>当用户提交订单时，订单系统会先向Seata Server服务，发起一个开启新的分布式事务的请求，并获取分布式事务对应的唯一标识xid，然后，订单系统本身也会开启一个本地数据库的分支事务。</p><p>库存系统接收到订单系统的rpc请求之后，也会在本地开启一个分支事务：</p><p>可以看到，库存系统在本地开启一个分支事务之后，紧接着，就会调用数据库缓存双写的入口逻辑，从这里开始，我们就进入到了Seata TCC分布式事务的运行范围之内了。</p><figure><img src="'+yn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，首先会依次调用写库接口和写缓存接口的try方法了，当所有接口的try方法都执行成功之后，注意，此时并不是立即依次执行各个接口的confirm方法，而是顺着生单链路的执行流程，继续执行其他分支的事务。</p><p>和之前一样，订单系统获取本地锁执行落库生单操作，然后插入相应的回滚日志，最后获取全局锁提交分支事务，并释放本地锁。</p><p>比如，接下来该轮到订单系统的Seata分支事务执行了：</p><figure><img src="'+_n+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>当生单链路中的所有分支事务都执行完成之后，接下来，就会提交整体的Seata分布式事务了：</p><figure><img src="'+xn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，Seata分布式事务提交时，才会依次的去调用库存系统对应的Seata TCC分布式事务的confirm方法，提交库存系统的分支事务，最后，完成整体分支事务的提交。</p><p>可以看到，当Seata TCC分布式事务开始执行时，首先会添加一把分布式锁，然后开始执行各个接口的try方法，当所有接口的try方法都执行成功之后，分布式锁也就释放了，然后继续执行其他Seata分支事务了。</p><h4 id="_5-6-6-seata-tcc异步提交导致数据不一致" tabindex="-1"><a class="header-anchor" href="#_5-6-6-seata-tcc异步提交导致数据不一致" aria-hidden="true">#</a> 5.6. 6.Seata TCC异步提交导致数据不一致</h4><p>我们结合生单链路来看一下：</p><p>分析到这里，想必大家已经看出一些端倪了，也就是说Seata TCC分布式事务在执行时，依次执行完各个接口的try方法之后，并不是一气呵成执行各个接口的confirm方法，而是得要等到整体的Seata分布式事务提交时，才会依次执行各个接口的confirm方法，相当于Seata TCC分布式事务的提交阶段，是异步执行的了。</p><figure><img src="'+wn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时，如果当前正在执行的分布式事务，如果还没来得及执行confirm方法，此时，如果其他分布式事务过来执行锁定库存操作，大家觉得try方法的执行会出问题吗？答案是不会的。</p><p>如图，可以看到在调用数据库缓存双写逻辑前，首先得要获取一把分布式锁：</p><figure><img src="'+Sn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>即使前一个分布式事务，已经将分布式锁释放了，但是，如果其他多个分布式事务过来执行各个接口的try方法，分布式锁还是能够保证多个分布式事务，顺序地执行各个接口的try方法的，所以，各个接口try方法的执行，还是可以保证并发安全性的。</p><p>问题就出在各个接口的confirm方法的执行，比如在当前数据库中，某个商品的库存数据的售库存为10，锁定库存为0：</p><p>可以看到，假如当前分布式事务1先执行写库接口的try方法后，销售库存扣减1从10变为9，然后，分布式事务1释放分布式锁后，继续去执行落库生单操作，库存的锁定操作，现在还差confirm方法累加锁定库存的操作。</p><figure><img src="'+En+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，假设此时分布式事务2，在分布式事务1初步锁定库存的基础上，获取相同的一件商品的库存数据，也就是销售库存为9，锁定库存为0，这个时候，分布式事务2获取到的库存数据中，锁定库存数据就出问题了。</p><p>这个时候，如果另一个分布式事务过来执行，就会出现问题了：</p><p>其他分布式事务过来，按理说正确获取到的库存数据，应该是上个分布式事务，已经锁定库存操作完毕的数据，而不是锁定库存逻辑执行一半的库存数据，所以，分布式事务2基于错误的数据，进行try方法以及后续的confirm方法的执行，就会出现数据不一致性的问题了。</p><figure><img src="'+Cn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>为了让其他分布式事务执行try方法时，能获取到正确的库存数据，我们可以在confirm方法调用结束后，随即插入一条库存数据的操作日志：</p><h4 id="_5-7-7-引入库存操作日志来解决数据不一致问题" tabindex="-1"><a class="header-anchor" href="#_5-7-7-引入库存操作日志来解决数据不一致问题" aria-hidden="true">#</a> 5.7. 7.引入库存操作日志来解决数据不一致问题</h4><p>现在的问题，关键在于一个分布式事务还没有来的及执行confirm方法，还没有完整的将整个分布式事务提交，其他分布式事务可能就会获取到错误的库存数据，那这个问题到底该怎么解决呢？</p><p>可以看到，我们可以预先在数据库中，定义一张库存数据的操作日志表，当confirm方法执行完毕之后，插入一条操作日志。</p><figure><img src="'+Tn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后当其他分布式事务来执行时：</p><p>可以看到，虽然分布式事务2在执行try方法时，获取到的库存数据中的销售库存数量是正确的，但是锁定库存的数量是错误的，正确的锁定库存数量应该为1。</p><figure><img src="'+Nn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此时，当分布式事务2在执行confirm方法时，就不能基于错误的锁定库存数据0，来进行库存的累加操作，而得要先从库存操作日志表中，获取最近最新插入的一条库存记录，查询最近提交的分布式事务修改后的最新锁定库存数据。</p><p>而分布式事务1执行confirm方法后，锁定库存的数量为1才是正确的，分布式事务2查询到这条数据后，基于正确的锁定库存数据进行confirm方法的执行，最终得到锁定库存数据结果2，才是正确的数据。</p><p>相应的，分布式事务2执行完confirm操作提交时，也会插入一条相应的库存操作日志，方便其他分布式事务执行时获取，这样的话，Seata TCC异步提交导致的数据不一致问题也就解决了。</p><p>为了解决Seata TCC异步提交而导致的数据不一致问题，我们引入了库存数据的操作日志来解决这个问题，也就是在每次执行confirm方法之后，都会往库存日志表中，插入一条库存数据变更的日志。</p><h4 id="_5-8-8-总结" tabindex="-1"><a class="header-anchor" href="#_5-8-8-总结" aria-hidden="true">#</a> 5.8. 8.总结</h4><p>这一节，我们首先回顾了一下之前基于Seata和Seata TCC的生单核心链路逻辑，然后，基于生单链路的执行流程，我们发现了一个问题，也就是Seata TCC的try方法和confirm方法的执行，其实是异步的，所以，库存数据这块，在多个分布式事务同时执行时，可能就会出现数据不一致的问题。</p><p>生单链路的一系列问题，包括涉及多个数据库的数据不一致问题、锁定库存时因为全局锁而导致的并发瓶颈问题、引入Seata TCC分布式事务后的空回滚，悬挂，confirm方法和cancel方法重复执行的幂等性问题以及Seata TCC异步提交而导致的数据不一致等一系列技术问题，我们都已经悉数解决了。</p><p>虽然其他的分布式事务在执行try方法时，拿到的锁定库存数据是有问题的，但是，在具体执行confirm方法时，可以从库存日志表中，查询最近最新的一条库存操作日志，从日志中获取最新的库存数据，这样的话，锁定库存数据不一致的问题也就得到解决了。</p><p>从下一节开始，我们顺着生单链路的执行流程，继续来看下生单链路之后的订单预支付和支付回调链路中，业务流程是怎样的，并且可能会遇到哪些技术问题。</p>',171),Ca={href:"https://seata.io/zh-cn/blog/seata-tcc-fence.html",target:"_blank",rel:"noopener noreferrer"},Ta=t(`<h2 id="_14-统一响应体-nacos可配置全局异常" tabindex="-1"><a class="header-anchor" href="#_14-统一响应体-nacos可配置全局异常" aria-hidden="true">#</a> 14. 统一响应体+Nacos可配置全局异常</h2><h3 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h3><p>我们知道接口的返回，一般情况下就只有三种状态，成功、失败和超时响应，而接口的方法调用结果可能会出现很多异常信息。在实际的业务开发过程中，我们要求接口的异常信息是一定要处理掉的，不能直接把一个堆栈信息返回给前端用户的。这样要求的原因是：</p><ol><li>一大堆的异常信息会影响用户体验。用户是不懂技术的，接口返回一大堆异常信息，用户本能的就认为系统出了问题，这影响用户体验；但是返回能够被用户所理解的信息，则是可以接受的。</li><li>暴露异常信息影响系统可用性评价。接口返回一大堆异常信息，除了用户本能的认为系统出了问题，业务部门也会觉得系统此时不可用。</li><li>异常信息千奇百怪，不利于前端处理。</li></ol><p>事实上，一个架构优良的系统，是需要前端开发和后端开发相互配合的。前端和后端开发约定好接口的响应格式，然后再根据这个格式完成前后端的公共模块的开发。这个过程中后端对应的业务功能就是<code>全局统一响应</code>。</p><h3 id="_2-全局统一响应" tabindex="-1"><a class="header-anchor" href="#_2-全局统一响应" aria-hidden="true">#</a> 2. 全局统一响应</h3><p>实际上，我们可以把异常也归类为一种特殊的返回结果。全局统一响应有什么业务要求或业务特点呢？</p><p>对异常的要求：</p><ol><li>支持代码中抛出异常信息，并且抛出的异常信息的格式要求统一；</li><li>异常信息的格式应与接口正常响应或失败响应的消息体格式保持一致；</li><li>异常信息要支持国际化；</li><li>异常信息编码要具有业务含义；</li></ol><p>对响应的要求：</p><ol><li>支持默认的响应成功或响应失败的结果；</li><li>响应信息支持国际化；</li><li>与异常信息的格式保持一致；</li></ol><p>除了这些以外，还会有其他细化的需求。以下是几个常用的场景：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// 遇到业务出现异常时，直接抛出异常信息

// 有些前端传过来的请求参数需要做校验，遇到校验不通过的直接抛出异常信息

// 接口正常响应时，返回正常响应消息体

// 接口响应失败时，返回默认的响应失败消息体

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上面的业务特点，我们明确实现目标：</p><ol><li>Nacos作为配置中心，但是需要我们自行编写工具类，最终达到的目的是，同一个异常编码对应多国语言的异常信息，并且能够自动刷新（即修改Nacos立即生效）；</li><li>配合Validation使用时，对业务主流程侵入性达到最小，最好是零侵入；</li><li>统一响应体消息格式，并且可以直接使用success和error方法；</li><li>业务代码中抛出异常的方式与jdk抛出异常方式在使用方式上一致，但是业务中抛出的异常信息的响应结果与自定义的响应消息体格式保持一致；</li></ol><h3 id="_3-实战过程" tabindex="-1"><a class="header-anchor" href="#_3-实战过程" aria-hidden="true">#</a> 3. 实战过程</h3><p>主要包括三个方面：</p><ol><li>重写语言解析器。这个步骤是可选的，主要目的是改变请求头里面语言的属性名。</li><li>构建配置信息。这个步骤是把国际化的配置信息配置到配置中心，然后监听数据变更，并构建一个工具类让统一响应功能和统一异常处理功能使用。</li><li>构建统一响应消息体。这个步骤是格式化接口的响应信息，需要利用到上一步编写的工具类。</li><li>构建统一异常处理。这个步骤是格式化异常信息的响应信息，需要利用到第二步编写的工具类。</li></ol><h4 id="_3-1-重写语言解析器" tabindex="-1"><a class="header-anchor" href="#_3-1-重写语言解析器" aria-hidden="true">#</a> 3.1. 重写语言解析器</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class LanguageResolver implements LocaleResolver {
    /**
     * 请求header字段
     */
    private static final String LANG = &quot;lang&quot;;

    /**
     * session
     */
    private static final String LANG_SESSION = &quot;lang_session&quot;;
    @Override
    public Locale resolveLocale(HttpServletRequest request) {
        String lang = request.getHeader(LANG);
        Locale locale = Locale.getDefault();
        if (StringUtils.isNotBlank(lang)){
            String[] language = lang.split(&quot;_&quot;);
            locale = new Locale(language[0], language[1]);

            HttpSession session = request.getSession();
            session.setAttribute(LANG_SESSION, locale);
        }else{
            HttpSession session = request.getSession();
            Locale localeInSession = (Locale) session.getAttribute(LANG_SESSION);
            if (localeInSession != null){
                locale = localeInSession;
            }
        }
        return locale;
    }

    @Override
    public void setLocale(HttpServletRequest request, HttpServletResponse response, Locale locale) {

    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Configuration
public class MessageConfig {

    @Bean
    public LocaleResolver localeResolver(){
        return new LanguageResolver();
    }

}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-构建配置信息" tabindex="-1"><a class="header-anchor" href="#_3-2-构建配置信息" aria-hidden="true">#</a> 3.2. 构建配置信息</h4><p>这里我们选用Alibaba-Nacos组件。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>server:
  port: 10300
spring:
  application:
    name: global-exception
  cloud:
    nacos:
      config:
        # nacos的服务端地址
        server-addr: 192.168.1.150:8848
        # 应用接入的命名空间的id
        namespace: 8d269024-f215-4195-be82-f6343cafde9c
        # 命名分组
        group: DEV

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置一个枚举类，枚举出所有的国际化的异常码表。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public enum NacosJson2ObjEnum {

    MESSAGE_ZH_CN(&quot;message_zh_cn&quot;, &quot;业务异常码表（简中）&quot;, Map.class),
    MESSAGE_EN_US(&quot;message_en_us&quot;, &quot;业务异常码表（英文）&quot;, Map.class)
    ;

    private String dataId;
    private String desc;
    private Class clz;

    NacosJson2ObjEnum(String dataId, String desc, Class clz) {
        this.dataId = dataId;
        this.desc=desc;
        this.clz =clz;
    }

    public String getDataId(){
        return dataId;
    }

    public String getDesc(){
        return desc;
    }

    public Class getClz(){
        return clz;
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>利用Spring初始化Bean机制，把国际化异常码表信息加载本地内存中，并设置监听器监听Nacos上面的配置变化。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Slf4j
@Component
public class NacosConfig implements InitializingBean {
    @Autowired
    private NacosConfigProperties nacosConfigProperties;

    @Value(&quot;\${spring.cloud.nacos.config.group}&quot;)
    private String group;

    private ConfigService configService;
    private Map&lt;String, Object&gt; localCatchMap = new HashMap&lt;&gt;();

    private static ThreadPoolExecutor executor =
            new ThreadPoolExecutor(
                    2,
                    4,
                    1,
                    TimeUnit.SECONDS,
                    new LinkedBlockingDeque&lt;&gt;(100),
                    new ThreadPoolExecutor.CallerRunsPolicy()
            );

    @Override
    public void afterPropertiesSet() throws Exception {
        // 获取 Nacos 服务端 具体配置
        String serverAddr = nacosConfigProperties.getServerAddr();
        String namespace = nacosConfigProperties.getNamespace();

        // 封装 Nacos server 配置参数
        Properties properties = new Properties();
        properties.put(PropertyKeyConst.SERVER_ADDR, serverAddr);
        properties.put(PropertyKeyConst.NAMESPACE, namespace);
        if (configService == null) {
            configService = NacosFactory.createConfigService(properties);
        }

        NacosJson2ObjEnum[] nacosJson2ObjEnums = NacosJson2ObjEnum.values();
        for (NacosJson2ObjEnum nacosJson2ObjEnum : nacosJson2ObjEnums) {
            String dataId = nacosJson2ObjEnum.getDataId();
            String config = configService.getConfig(dataId, group, 1000);

            // 把获取到的配置信息放到本地map中
            jsonToObject(config, nacosJson2ObjEnum);

            // 设置监听器，监听配置变化
            configService.addListener(
                    nacosJson2ObjEnum.getDataId(),
                    group,
                    new NacosJsonConfigDataListener(nacosJson2ObjEnum)
            );
        }

    }

    public void jsonToObject(String json, NacosJson2ObjEnum eNacosJsonDefinition) {
        Object data = JSON.parseObject(json, eNacosJsonDefinition.getClz());
        log.info(&quot;Get Nacos Config Data, dataId = {} --- data = {}&quot;,
                eNacosJsonDefinition.getDataId(), data);
        localCatchMap.put(eNacosJsonDefinition.getDataId(), data);
    }

    public class NacosJsonConfigDataListener implements Listener {
        private NacosJson2ObjEnum nacosJson2ObjEnum;

        private NacosJsonConfigDataListener(NacosJson2ObjEnum nacosJson2ObjEnum) {
            this.nacosJson2ObjEnum = nacosJson2ObjEnum;
        }

        @Override
        public Executor getExecutor() {
            return executor;
        }

        @Override
        public void receiveConfigInfo(String configInfo) {
            jsonToObject(configInfo, nacosJson2ObjEnum);
        }
    }

    public &lt;T&gt; T getNacosJson2Object(NacosJson2ObjEnum nacosJson2ObjEnum, Class&lt;? extends T&gt; clz) {
        Object data = localCatchMap.get(nacosJson2ObjEnum.getDataId());
        if (clz.isInstance(data)) {
            return (T)data;
        }
        throw new IllegalArgumentException(&quot;转换类型失败&quot;);
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对外提供一个工具类，获取国际化的异常信息。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class MessageNacosUtil {

    @Autowired
    private static NacosConfig nacosConfig;

    @Autowired
    public void setNacosConfig(NacosConfig nacosConfig) {
        MessageNacosUtil.nacosConfig = nacosConfig;
    }

    public static String getExcptMsg(String excptCode) {
        return StrFormatter.format(getMessageMap().get(excptCode), null);
    }

    public static String getExcptMsg(String excptCode, String... args) {
        return StrFormatter.format(getMessageMap().get(excptCode), args);
    }

    public static Map&lt;String, String&gt; getMessageMap(){
        Map&lt;String, String&gt; messageMap = null;
        String language = LocaleContextHolder.getLocale().getLanguage();
        if (&quot;&quot;.equals(language) || &quot;zh&quot;.equals(language)) {
            messageMap = nacosConfig.getNacosJson2Object(NacosJson2ObjEnum.MESSAGE_ZH_CN, Map.class);
        } else {
            messageMap = nacosConfig.getNacosJson2Object(NacosJson2ObjEnum.MESSAGE_EN_US, Map.class);
        }
        return messageMap;
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-构建统一响应消息体" tabindex="-1"><a class="header-anchor" href="#_3-3-构建统一响应消息体" aria-hidden="true">#</a> 3.3. 构建统一响应消息体</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseResponse</span><span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseResponse</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 如果响应结果中只给了code，那么msg就去nacos中查询
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DataResponse</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataResponse</span> dataResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageNacosUtil</span><span class="token punctuation">.</span><span class="token function">getExcptMsg</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DataResponse</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataResponse</span> dataResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataResponse<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 响应成功的消息进行固定并统一
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DataResponse</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token class-name">ResponseStatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 响应失败支持自定义code和msg
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataResponse</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 默认的响应失败结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataResponse</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token class-name">ResponseStatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-构建统一异常处理" tabindex="-1"><a class="header-anchor" href="#_3-4-构建统一异常处理" aria-hidden="true">#</a> 3.4. 构建统一异常处理</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BizException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">BaseResponse</span> baseResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">BaseResponse</span> baseResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>baseResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;, &quot;</span><span class="token operator">+</span> baseResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse <span class="token operator">=</span> baseResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">BaseResponse</span> baseResponse<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>baseResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> baseResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse <span class="token operator">=</span> baseResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 抛出异常支持多个msg进行组合拼装
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>code<span class="token operator">+</span> <span class="token string">&quot;, &quot;</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> excptMsg <span class="token operator">=</span> <span class="token class-name">MessageNacosUtil</span><span class="token punctuation">.</span><span class="token function">getExcptMsg</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>excptMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>code<span class="token operator">+</span> <span class="token string">&quot;, &quot;</span><span class="token operator">+</span>msg<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关键一步，重写自定义的异常信息。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(value = BizException.class)   // 项目中遇到 BizException 时的处理逻辑
    public ResponseEntity bizExceptionHandler(BizException bizException) {
        BaseResponse baseResponse = bizException.getBaseResponse();
        return new ResponseEntity(baseResponse, HttpStatus.OK);
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-使用" tabindex="-1"><a class="header-anchor" href="#_4-使用" aria-hidden="true">#</a> 4. 使用</h3><p>开发过程中还涉及到请求参数的校验过程，这里我们选用Validation的工具类。下面是集成过程。</p><h4 id="_4-1-集成validation" tabindex="-1"><a class="header-anchor" href="#_4-1-集成validation" aria-hidden="true">#</a> 4.1. 集成Validation</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(value = BizException.class)
    public ResponseEntity bizExceptionHandler(BizException bizException) {
        BaseResponse baseResponse = bizException.getBaseResponse();
        return new ResponseEntity(baseResponse, HttpStatus.OK);
    }

    // 遇到 参数校验时的异常处理
    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    public ResponseEntity methodArgumentNotValidExceptionHandler(MethodArgumentNotValidException methodArgumentNotValidException) {
        BindingResult bindingResult = methodArgumentNotValidException.getBindingResult();
        if (bindingResult.getFieldErrors() != null) {
            // 如果校验结果中有多个异常，就只返回第一个异常信息
            String excptCode = bindingResult.getFieldErrors().get(0).getDefaultMessage();
            String excptMsg = MessageNacosUtil.getExcptMsg(excptCode);
            BizException bizException = new BizException(excptCode, excptMsg);
            return new ResponseEntity(bizException.getBaseResponse(), HttpStatus.OK);
        }
        return new ResponseEntity(null, HttpStatus.OK);
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-测试" tabindex="-1"><a class="header-anchor" href="#_4-2-测试" aria-hidden="true">#</a> 4.2. 测试</h4><p>我们在nacos上添加配置文件，并填充内容。</p><figure><img src="`+An+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+qn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Rn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们编写一个controller进行测试：</p><ol><li>直接抛出业务异常</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@GetMapping(&quot;/throw2_01&quot;)
public OperationResponse test02_01() {

    if (&quot;0&quot;.equals(&quot;0&quot;)) {
        throw new BizException(ResponseStatusCode.EE1001);
    }
    return OperationResponse.success(MessageNacosUtil.getExcptMsg(ResponseStatusCode.OK));
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+Ln+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+In+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="2"><li>抛出校验异常</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
@Data
public class UserDTO {

    // 校验注解的message直接为一个常量字符串
    @NotEmpty(message = ResponseStatusCode.EE2001)
    private String name;

    @NotBlank(message = ResponseStatusCode.EE2002)
    private String address;


    private String sex;
    private Integer age;
    private Long phonenum;
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@PostMapping(&quot;/throw2_02&quot;)
public DataResponse&lt;UserDTO&gt; test02_02(
        @RequestBody @Validated UserDTO userDTO
) {
    return DataResponse.success(userDTO);
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+On+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Mn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Un+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',60),Na={href:"/NotBlank",target:"_blank",rel:"noopener noreferrer"},Aa={href:"/NotEmpty",target:"_blank",rel:"noopener noreferrer"},qa=t(`<p>注意： 上面的捕获MethodArgumentNotValidException后的处理逻辑中只处理了所抛出的第一个异常信息，自测多次同一个请求类，由于是多个字段校验，可能会抛出不同的异常信息，这里需要做自定义实现。</p><ol start="3"><li>抛出组合后的异常信息</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@PostMapping(&quot;/throw2_03&quot;)
public DataResponse&lt;UserDTO&gt; test02_03(
        @RequestBody @Validated UserDTO userDTO
) {
    if (&quot;female&quot;.equals(userDTO.getSex())) {
        throw new BizException(ResponseStatusCode.EE3001, userDTO.getName());
    }
    return DataResponse.success(userDTO);
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+Dn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>抛出多个参数组成的异常信息</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@PostMapping(&quot;/throw2_04&quot;)
public DataResponse&lt;UserDTO&gt; test02_04(
        @RequestBody @Validated UserDTO userDTO
) {
    if (&quot;female&quot;.equals(userDTO.getSex()) &amp;&amp; userDTO.getPhonenum()&lt;138000) {
        throw new BizException(ResponseStatusCode.EE3002, userDTO.getName(), String.valueOf(userDTO.getPhonenum()));
    }
    return DataResponse.success(userDTO);
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+zn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+jn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="5"><li>返回默认的响应失败消息体</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@PostMapping(&quot;/throw2_05&quot;)
public DataResponse&lt;UserDTO&gt; test02_05(
        @RequestBody @Validated UserDTO userDTO
) {
    return DataResponse.error();

}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+Bn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_5-参考" tabindex="-1"><a class="header-anchor" href="#_5-参考" aria-hidden="true">#</a> 5. 参考</h3>',12),Ra={href:"https://blog.csdn.net/qq_15898739/article/details/104680114",target:"_blank",rel:"noopener noreferrer"},La={href:"https://mp.weixin.qq.com/s/XE4R2wOj08qNivo8Ms5ZRQ",target:"_blank",rel:"noopener noreferrer"},Ia={href:"https://developer.aliyun.com/article/1180037",target:"_blank",rel:"noopener noreferrer"},Oa=n("h2",{id:"_15-多租户saas实战",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_15-多租户saas实战","aria-hidden":"true"},"#"),s(" 15. 多租户SaaS实战")],-1),Ma={href:"https://mp.weixin.qq.com/s/6Gihii6HtBsgcbiQ-2XvUg",target:"_blank",rel:"noopener noreferrer"},Ua=n("li",null,"修改 application.yml 数据库URL、账户、密码",-1),Da=t(`<div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>
<span class="token key atrule">url</span><span class="token punctuation">:</span>  jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.100.100<span class="token punctuation">:</span>3306/test_una_saas<span class="token punctuation">?</span>useSSL=false
<span class="token key atrule">username</span><span class="token punctuation">:</span> admin
<span class="token key atrule">password</span><span class="token punctuation">:</span> admin@2020<span class="token tag">!@</span><span class="token comment">#</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>创建application.yml数据库URL对应的schema，并在改数据库中创建<code>master_tenant</code>表。</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>schema： test_una_saas
table： master_tenant
SQL： 
    CREATE TABLE \`master_tenant\` (
      \`ID\` varchar(255) NOT NULL,
      \`TENANT\` varchar(30) NOT NULL,
      \`URL\` varchar(255) NOT NULL,
      \`USERNAME\` varchar(30) NOT NULL,
      \`PASSWORD\` varchar(30) NOT NULL,
      \`version\` int(11) NOT NULL,
      PRIMARY KEY (\`ID\`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>在<code>master_tenant</code>表中插入一条数据</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>master_tenant<span class="token punctuation">\`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;tenant_1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;firstTenant&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;jdbc:mysql://192.168.100.100:3306/db2020?useSSL=false&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;admin@2020!@#&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>创建schema，并创建user表</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>schema： db2020
table： user
SQL： 
    CREATE TABLE \`user\` (
      \`ID\` varchar(50) NOT NULL,
      \`USERNAME\` varchar(255) DEFAULT NULL,
      \`PASSWORD\` varchar(22) DEFAULT NULL,
      \`TENANT\` varchar(255) DEFAULT NULL,
      PRIMARY KEY (\`ID\`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>在db2020.user表中插入一条数据</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>user<span class="token punctuation">\`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;test&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;abc123456&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;firstTenant&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>使用<code>firstTenant</code>作为租户id，使用<code>test</code>作为用户名，使用<code>abc123456</code>作为登陆密码。</li></ol><figure><img src="`+Fn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Pn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="8"><li>使用另外一个链接和另外一个租户的用户再次登录，同样成功。</li></ol><h2 id="_16-统一管理依赖" tabindex="-1"><a class="header-anchor" href="#_16-统一管理依赖" aria-hidden="true">#</a> 16. 统一管理依赖</h2><p>为了更好的各个版本的依赖，我们搭建一个nexus私服，然后创建一个项目，配置好所有的依赖版本后，上传私服，然后让所有的模块都以这个模块父模块进行依赖，这样就达到所有的依赖的版本管理的目的。这也是spring官方starter的制作过程。</p><p>实际的本地开发过程中，可以不用搭建nexus私服。不过本篇文章可以带你体验一下官方Spring的Starter的制作过程。</p><h3 id="_1-安装并配置-nexus3" tabindex="-1"><a class="header-anchor" href="#_1-安装并配置-nexus3" aria-hidden="true">#</a> 1. 安装并配置 nexus3</h3><h4 id="_1-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-1-安装" aria-hidden="true">#</a> 1.1. 安装</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker pull sonatype/nexus3

mkdir -p /mydata/nexus/data
chmod 777 -R /mydata/nexus

docker run -d --name nexus -p 8081:8081 \\
--restart always \\
-v /mydata/nexus/data:/nexus-data sonatype/nexus3

docker logs -f nexus

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-配置" tabindex="-1"><a class="header-anchor" href="#_1-2-配置" aria-hidden="true">#</a> 1.2. 配置</h4><p>安装完成之后，需要对 nexus 进行一些初始化配置。</p><h5 id="_1-2-1-修改-admin-的密码" tabindex="-1"><a class="header-anchor" href="#_1-2-1-修改-admin-的密码" aria-hidden="true">#</a> 1.2.1. 修改 admin 的密码</h5><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cat /mydata/nexus/data/admin.password

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>登录页面后修改密码： root1003</p><h5 id="_1-2-2-web页面上配置用于上传自定义包的用户" tabindex="-1"><a class="header-anchor" href="#_1-2-2-web页面上配置用于上传自定义包的用户" aria-hidden="true">#</a> 1.2.2. web页面上配置用于上传自定义包的用户</h5><ul><li>创建角色</li></ul><figure><img src="`+Gn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>创建用户</li></ul><figure><img src="'+Hn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_2-配置maven的config" tabindex="-1"><a class="header-anchor" href="#_2-配置maven的config" aria-hidden="true">#</a> 2. 配置maven的config</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
&lt;server&gt;
    &lt;id&gt;maven-public&lt;/id&gt;
    &lt;username&gt;zeanzai&lt;/username&gt;
    &lt;password&gt;root1003&lt;/password&gt;
&lt;/server&gt;
&lt;server&gt;
    &lt;id&gt;maven-releases&lt;/id&gt;
    &lt;username&gt;zeanzai&lt;/username&gt;
    &lt;password&gt;root1003&lt;/password&gt;
&lt;/server&gt;
&lt;server&gt;
    &lt;id&gt;maven-snapshots&lt;/id&gt;
    &lt;username&gt;zeanzai&lt;/username&gt;
    &lt;password&gt;root1003&lt;/password&gt;
&lt;/server&gt;

    &lt;mirror&gt;
    &lt;id&gt;maven-public&lt;/id&gt;
    &lt;name&gt;maven-public&lt;/name&gt;
    &lt;url&gt;http://192.168.1.150:8081/repository/maven-public/&lt;/url&gt;
    &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
&lt;/mirror&gt;

&lt;profile&gt; 
    &lt;id&gt;jdk-1.8&lt;/id&gt; 
    &lt;activation&gt; 
    &lt;activeByDefault&gt;true&lt;/activeByDefault&gt; 
    &lt;jdk&gt;1.8&lt;/jdk&gt; 
    &lt;/activation&gt; 
    &lt;properties&gt; 
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; 
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt; 
    &lt;maven.compiler.compilerVersion&gt;1.8&lt;/maven.compiler.compilerVersion&gt; 
    &lt;/properties&gt; 
&lt;/profile&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-项目pom文件中的配置" tabindex="-1"><a class="header-anchor" href="#_3-项目pom文件中的配置" aria-hidden="true">#</a> 3. 项目pom文件中的配置</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;distributionManagement&gt;
    &lt;repository&gt;
        &lt;id&gt;maven-releases&lt;/id&gt;
        &lt;url&gt;http://192.168.1.150:8081/repository/maven-releases/&lt;/url&gt;
    &lt;/repository&gt;
    &lt;snapshotRepository&gt;
        &lt;id&gt;maven-snapshots&lt;/id&gt;
        &lt;url&gt;http://192.168.1.150:8081/repository/maven-snapshots/&lt;/url&gt;
    &lt;/snapshotRepository&gt;
&lt;/distributionManagement&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意此处的id要与maven中的server中的id保持一致。</p><h3 id="_4-deploy——部署到私服" tabindex="-1"><a class="header-anchor" href="#_4-deploy——部署到私服" aria-hidden="true">#</a> 4. deploy——部署到私服</h3><ul><li>在maven的窗口中，找到“create..”：</li></ul><figure><img src="`+Yn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>在打开的窗口中输入 <code>clean deploy -DskipTests</code> ：</li></ul><figure><img src="'+Kn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>运行命令，发布到nexus私服上：</li></ul><figure><img src="'+Vn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>运行结果：</li></ul><figure><img src="'+Jn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Zn+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_5-其他模块中的引用" tabindex="-1"><a class="header-anchor" href="#_5-其他模块中的引用" aria-hidden="true">#</a> 5. 其他模块中的引用</h3><p>在其他模块中统一引用我们自定义的starter依赖，这样就能进行统一的依赖的版本管理了。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;parent&gt;
    &lt;groupId&gt;com.tianqingxiaozhu&lt;/groupId&gt;
    &lt;artifactId&gt;tianqingxiaozhu-starter&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
&lt;/parent&gt;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-特别说明-1" tabindex="-1"><a class="header-anchor" href="#_6-特别说明-1" aria-hidden="true">#</a> 6. 特别说明</h3><p>在团队中一般是团队中的重要成员才有推送到私服的权限，因此在实际的开发过程中普通程序员是不需要创建私服的。各位读者在实践过程中，也可以直接创建一个模块，然后把这个模块安装到本地仓库后，在其他模块中引入对应坐标即可。</p><h3 id="_7-springcloud的版本" tabindex="-1"><a class="header-anchor" href="#_7-springcloud的版本" aria-hidden="true">#</a> 7. SpringCloud的版本</h3><p>分为很多个组件，每一个组件都有自己的版本坐标，这个也很好理解，SpringCloud是一个大型的工程，在这个工程里面有很多组件，每一个组件都是由一个小团队负责交付，由于负责不同的组件的团队不同，所以组件的交付时间节点肯定不一样，所以SpringCloud有一个自己的版本，这个版本中每一个组件的版本是不同的。</p><h4 id="_7-1-springcloud-alibaba的版本" tabindex="-1"><a class="header-anchor" href="#_7-1-springcloud-alibaba的版本" aria-hidden="true">#</a> 7.1. SpringCloud-Alibaba的版本</h4><p>SpringCloud-Alibaba是基于SpringBoot开发的，也是有不同的组件组成的。</p><p>因此二者有一个对应关系。</p><h4 id="_7-2-对应关系" tabindex="-1"><a class="header-anchor" href="#_7-2-对应关系" aria-hidden="true">#</a> 7.2. 对应关系</h4><figure><img src="`+Wn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+Xn+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们选取的版本如下：</p><ul><li>JDK1.8</li><li>CentOS7.9</li><li>SpringBoot-2.2.5.RELEASE</li><li>SpringCloud-Hoxton.SR3</li><li>SpringCloudAlibaba-2.2.1.RELEASE</li><li>Nacos1.2.1</li><li>Seata1.3.0</li><li>Sentinel1.7.1</li><li>...</li></ul><h4 id="_7-3-创建服务模块的方法" tabindex="-1"><a class="header-anchor" href="#_7-3-创建服务模块的方法" aria-hidden="true">#</a> 7.3. 创建服务模块的方法</h4><p>项目使用idea中的 Spring Initializer 进行生成。这样做的好处是<code>当团队规模较大，并且每一个团队都负责一个模块时，可以让不同的团队只需要下载自己负责的模块代码即可，便于代码权限的管理</code>。</p><h2 id="_17-如何设计一个安全可靠的api接口" tabindex="-1"><a class="header-anchor" href="#_17-如何设计一个安全可靠的api接口" aria-hidden="true">#</a> 17. 如何设计一个安全可靠的API接口</h2>',62),za={href:"https://blog.csdn.net/zhipengfang/article/details/117455598",target:"_blank",rel:"noopener noreferrer"},ja=n("h2",{id:"_18-文章列表",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_18-文章列表","aria-hidden":"true"},"#"),s(" 18. 文章列表")],-1),Ba={class:"task-list-container"},Fa=t('<li>『<a href="before_chaptera">你真的了解技术选型吗？</a>』</li><li>『<a href="before_chapterb">如何在SpringCloud项目中统一管理依赖的版本？</a>』</li><li>『<a href="before_easycode">使用idea插件生成代码</a> 』</li><li>『<a href="before_env">开发环境搭建手册</a>』</li><li>『<a href="chapter01">服务治理之Nacos</a> 』</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-0" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-0"> 传统调用方式</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-1" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-1"> 使用openfeign方式进行调用</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-2" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-2"> 注册到不同的命名空间以进行服务隔离</label></li><li>『<a href="chapter02">服务配置之Nacos</a>』</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-3" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-3"> 传统读取配置文件方式</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-4" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-4"> 从配置中心中读取配置项</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-5" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-5"> 从共享配置文件中读取配置项</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-6" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-6"> 把共享配置文件中的配置项映射成JavaBean</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-7" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-7"> 以服务名作为命名空间进行配置隔离</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-8" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-8"> 以环境名作为命名空间进行配置隔离</label></li><li>『<a href="chapter03">服务调用之OpenFeign</a>』</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-9" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-9"> 多参数</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-10" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-10"> URL中携带参数</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-11" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-11"> 传递对象</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-12" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-12"> 文件上传</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-13" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-13"> 文件下载</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-14" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-14"> 开启GZIP压缩</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-15" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-15"> 开启日志</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-16" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-16"> 超时控制</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-17" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-17"> 替换客户端</label></li><li>『<a href="chapter04">服务网关之Gateway</a>』</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-18" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-18"> 结合配置中心进行请求转发</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-19" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-19"> 重写路由</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-20" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-20"> 路由规则可配置化</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-21" disabled="disabled"><label class="task-list-item-label" for="task-item-21"> https的使用[xxx] 现在微服务的部署架构大多情况下是SLB+Nginx类型的部署模型，而微服务大多都是在内网环境中，因此网关也很少使用https；</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-22" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-22"> 集成swagger</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-23" disabled="disabled"><label class="task-list-item-label" for="task-item-23"> CROS方案</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-24" disabled="disabled"><label class="task-list-item-label" for="task-item-24"> 灰度发布 ：</label></li>',33),Pa={class:"task-list-item"},Ga=n("input",{type:"checkbox",class:"task-list-item-checkbox",id:"task-item-25",disabled:"disabled"},null,-1),Ha={class:"task-list-item-label",for:"task-item-25"},Ya={href:"https://blog.csdn.net/kingwinstar/article/details/105752725",target:"_blank",rel:"noopener noreferrer"},Ka={class:"task-list-item"},Va=n("input",{type:"checkbox",class:"task-list-item-checkbox",id:"task-item-26",disabled:"disabled"},null,-1),Ja={class:"task-list-item-label",for:"task-item-26"},Za={href:"https://github.com/lyb-geek/gateway",target:"_blank",rel:"noopener noreferrer"},Wa=t('<li>分布式事务管理之Seata <ul><li>『<a href="seata_distribute-transaction">分布式事务概论</a>』</li><li>『<a href="seata_install-seata">Seata服务端环境搭建</a>』</li><li>『<a href="seata_seata-at">AT模式</a>』</li><li>『<a href="seata_seata-tcc">TCC模式</a>』</li></ul></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-27" disabled="disabled"><label class="task-list-item-label" for="task-item-27"> Saga 模式</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-28" disabled="disabled"><label class="task-list-item-label" for="task-item-28"> 两阶段提交事务</label></li>',3),Xa={class:"task-list-item"},Qa=n("input",{type:"checkbox",class:"task-list-item-checkbox",id:"task-item-29",disabled:"disabled"},null,-1),$a={class:"task-list-item-label",for:"task-item-29"},ne={href:"https://mp.weixin.qq.com/s/Q7Xv8cypQFrrOQhbd9BOXw",target:"_blank",rel:"noopener noreferrer"},se=t('<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-30" disabled="disabled"><label class="task-list-item-label" for="task-item-30"> 持久化配置</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-31" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-31"> 基于网关的限流及自定义限流异常</label></li><li>『<a href="chapter06">分布式服务消息处理</a>』</li><li>『<a href="chapter07">分布式服务流量控制</a>』</li><li>『<a href="chapter08">分布式服务缓存</a>』</li><li>『<a href="chapter09">分布式服务链路追踪</a>』</li><li>『<a href="chapter10">分库分表</a>』</li><li>『<a href="chapter11">分布式服务Job</a>』</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-32" disabled="disabled"><label class="task-list-item-label" for="task-item-32"> 基于RabbitMQ使用消息中间件</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-33" disabled="disabled"><label class="task-list-item-label" for="task-item-33"> 创建交换机、binding 、 queue</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-34" disabled="disabled"><label class="task-list-item-label" for="task-item-34"> 发送消息</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-35" disabled="disabled"><label class="task-list-item-label" for="task-item-35"> 发送消息并确认</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-36" disabled="disabled"><label class="task-list-item-label" for="task-item-36"> 接受消息</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-37" disabled="disabled"><label class="task-list-item-label" for="task-item-37"> 接受消息并确认</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-38" disabled="disabled"><label class="task-list-item-label" for="task-item-38"> Cache</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-39" disabled="disabled"><label class="task-list-item-label" for="task-item-39"> 其他</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-40" disabled="disabled"><label class="task-list-item-label" for="task-item-40"> 分布式锁</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-41" disabled="disabled"><label class="task-list-item-label" for="task-item-41"> 分布式事务原理</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-42" disabled="disabled"><label class="task-list-item-label" for="task-item-42"> 分布式ID</label></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-43" disabled="disabled"><label class="task-list-item-label" for="task-item-43"> 分布式相关算法</label><ul><li><a href="other_create-a-niubi-api">如何设计一个安全可靠的API接口</a></li><li><a href="other_una-saas-toturial">多租户SaaS实战</a></li><li><a href="other_global-exception">统一响应体+Nacos可配置全局异常</a></li></ul></li>',20);function ae(ee,te){const a=c("ExternalLinkIcon");return l(),p("div",null,[$n,n("ul",null,[n("li",null,[n("a",ns,[s("Apollo下载与安装"),e(a)])]),n("li",null,[n("a",ss,[s("Apollo官方文档"),e(a)])])]),as,n("ol",null,[n("li",null,[n("a",es,[s("淘东电商项目（10） -Apollo分布式配置中心管理application.yml"),e(a)])]),n("li",null,[n("a",ts,[s("携程 Apollo v1.4 开发指南"),e(a)])])]),is,n("p",null,[s("关于如何做技术选型，参见《"),n("a",ls,[s("你真的会做技术选型吗？"),e(a)]),s("》。")]),ps,n("p",null,[s("浏览器打开： "),n("a",cs,[s("http://192.168.1.150:8848/nacos"),e(a)]),s(" 出现管理台页面，输入用户名密码： nacos/nacos ，登录成功。")]),os,n("p",null,[s("目前，Java领域的配置中心大概有这么几种： Nacos、ZK、Apollo、SpringCloud-Config等。关于不同技术类型的选择方法，参见《"),n("a",us,[s("你真的会做技术选型吗？"),e(a)]),s("》，这里不再赘述，本篇文章，主要介绍一下nacos相关内容。")]),ds,rs,ks,n("ul",null,[n("li",null,[s("Data ID ：配置项的唯一标识，可以理解为一个配置文件，它的命名格式是： "),vs,s("， 其中prefix为前缀，默认是 "),n("a",ms,[s("spring.application.name"),e(a)]),s(" 的值，当然也可以通过 spring.cloud.nacos.config.prefix 来进行配置；spring.profiles.active为项目生效的profile的名称，这个值和前面的短横杠为空时，DataID变成 "),bs,s("，这种方式也是合法的；file-exetension表示配置文件的格式，目前只支持 "),gs,s(" 和 "),hs,s(" 类型；")]),fs]),ys,_s,xs,n("p",null,[s("直接使用 "),n("a",ws,[s("@Value "),e(a)]),s(" 注解获取即可。实现的大概过程是：")]),Ss,Es,n("ol",Cs,[n("li",null,[s("通过 "),n("a",Ts,[s("@Value "),e(a)]),s(" 注解获取配置信息；")])]),Ns,n("p",null,[s("获取变更后的配置文件，我们只需要在获取的接口上添加 "),n("a",As,[s("@RefreshScope "),e(a)]),s(" 注解即可。")]),qs,n("ul",null,[n("li",null,[s("服务消费者使用 "),n("a",Rs,[s("@RequestParam "),e(a)]),s(" 标注服务生产者接受的两个参数的参数名，")])]),Ls,n("ul",null,[n("li",null,[s("服务消费者使用 "),n("a",Is,[s("@PathVariable "),e(a)]),s(" 注解进行标注生产者的参数名，")])]),Os,n("ul",null,[n("li",null,[s("消费者使用 "),n("a",Ms,[s("@RequestPart "),e(a)]),s(" 注解进行标注生产者的参数名，特别注意的是需要 "),n("a",Us,[s("@PostMapping "),e(a)]),s(" 注解要添加 produces 和 consumes 的值，这两个属性标注了生产者接受的媒体类型和需要处理的媒体类型。")])]),Ds,n("ul",null,[n("li",null,[s("消费者使用 "),n("a",zs,[s("@RequestBody "),e(a)]),s(" 标注生产者接受的参数的类型")])]),js,n("ol",null,[n("li",null,[s("由于启动类上添加了 "),n("a",Bs,[s("@EnableFeignClients "),e(a)]),s(" 注解，并标注了需要扫描@FeignClients客户端所在的包路径，程序启动时会扫描包路径，并把这些信息注入到Spring的容器中；")]),Fs,Ps]),Gs,n("p",null,[s("物理网关我们暂且不表，后端服务中常见的可以作为网关服务的组件，主要根据所使用的编程语言不同进行区分。常见的有Go的etcd，Java中的Zuul、Gateway等。这里我们不再详细描述技术选型，有兴趣的可以查阅《"),n("a",Hs,[s("你真的会做技术选型吗？"),e(a)]),s("》。")]),Ys,n("p",null,[s("浏览器中输入： "),n("a",Ks,[s("http://localhost:15000?green"),e(a)]),s(" ，点击回车后，浏览器会跳转到百度网站，")]),Vs,n("p",null,[s("网关根据断言的不同以及过滤器的不同，通过组合使用来适用不同的应用场景。有兴趣的读者可以阅读"),n("a",Js,[s("官方文档"),e(a)]),s("动手实践一下。")]),Zs,n("p",null,[s("要想把单个微服务的API文档聚合到一起，最主要的任务是要解决不同微服务的路由地址的转发不一致问题。我们这里使用"),n("a",Ws,[s("Knife4j"),e(a)]),s("。")]),Xs,n("ol",null,[n("li",null,[n("a",Qs,[s("SpringCloud 网关组件 Gateway 原理深度解析"),e(a)])]),n("li",null,[n("a",$s,[s("spring-cloud gateway 网关调优"),e(a)])]),n("li",null,[n("a",na,[s("SpringCloud Gateway 路由转发性能优化"),e(a)]),n("ol",null,[sa,aa,n("li",null,[n("a",ea,[s("几种性能测试工具的总结"),e(a)])]),n("li",null,[n("a",ta,[s("SpringCloud Gateway 路由数量对性能的影响研究"),e(a)])]),n("li",null,[n("a",ia,[s("SpringCloud Gateway 路由转发性能优化"),e(a)])]),n("li",null,[n("a",la,[s("SpringCloud Gateway 动态路由"),e(a)])]),n("li",null,[n("a",pa,[s("https://gitee.com/eblog/scgw-benchmark-all"),e(a)])])])]),n("li",null,[n("a",ca,[s("CPU性能优化干货总结"),e(a)])]),n("li",null,[n("a",oa,[s("大厂里一直讲的p99,p95到底是什么？"),e(a)]),ua]),n("li",null,[n("a",da,[s("Spring Cloud Gateway之踩坑日记"),e(a)])]),n("li",null,[n("a",ra,[s("Spring Cloud Gateway压测(wrk、k8s、nginx）"),e(a)])])]),ka,n("p",null,[s("关于Seata的相关知识，可以先去官网了解一下。简单介绍一下，seata支持多种分布式事务，如AT模式、TCC模式、Sega模式等。"),n("a",va,[s("官网在这"),e(a)])]),ma,ba,ga,ha,fa,ya,n("p",null,[s("服务端版本及下载地址： "),n("a",_a,[s("1.3.0"),e(a)]),s(" 源代码版本及下载地址： "),n("a",xa,[s("1.3.0"),e(a)])]),wa,n("p",null,[s("进入安装包下面的bin目录，在命令行里面直接运行 "),n("a",Sa,[s("seata-server.sh"),e(a)]),s(" 即可。")]),Ea,n("p",null,[n("a",Ca,[s("TCC简介及Seata中的问题"),e(a)])]),Ta,n("p",null,[s("原理解读： "),n("a",Na,[s("@NotBlank "),e(a)]),s(" 和 "),n("a",Aa,[s("@NotEmpty "),e(a)]),s(" 注解校验不通过时，会抛出 MethodArgumentNotValidException 异常信息，而我们在 GlobalExceptionHandler 中捕获这个异常信息之后做了自定义处理逻辑，大概逻辑就是先获取到抛出异常信息的message信息，拿到异常码，之后利用工具类和语言信息从Nacos中获取异常码的描述信息。")]),qa,n("ul",null,[n("li",null,[n("a",Ra,[s("Nacos实现SpringBoot国际化的增强"),e(a)])]),n("li",null,[n("a",La,[s("Java统一异常处理(配置文件集中化定义)"),e(a)])]),n("li",null,[n("a",Ia,[s("三种手段：通过Apollo和nacos的能力进行国际化动态配置实现热更新"),e(a)])])]),Oa,n("ol",null,[n("li",null,[s("说明文档可以参考《"),n("a",Ma,[s("Spring Boot 构建多租户 SaaS 平台核心技术指南"),e(a)]),s("》。")]),Ua]),Da,n("p",null,[n("a",za,[s("面试四连问：API 接口如何设计？安全如何保证？防重如何实现？签名如何实现？..."),e(a)])]),ja,n("ul",Ba,[Fa,n("li",Pa,[Ga,n("label",Ha,[n("a",Ya,[s("https://blog.csdn.net/kingwinstar/article/details/105752725"),e(a)])])]),n("li",Ka,[Va,n("label",Ja,[n("a",Za,[s("https://github.com/lyb-geek/gateway"),e(a)])])]),Wa,n("li",Xa,[Qa,n("label",$a,[s(" Sentinel ： "),n("a",ne,[s("https://mp.weixin.qq.com/s/Q7Xv8cypQFrrOQhbd9BOXw"),e(a)])])]),se])])}const le=i(Qn,[["render",ae],["__file","springcloud.html.vue"]]);export{le as default};
